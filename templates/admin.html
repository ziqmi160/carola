{% extends "base.html" %}

{% block title %}Admin Dashboard - Carola Car Rental{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="container">
        <h1 class="page-title">Admin Dashboard</h1>
        <p class="page-subtitle">Manage cars, bookings, and system data</p>
        
        <!-- Tabs -->
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('cars')">
                <i class="fas fa-car"></i> Cars Management
            </button>
            <button class="tab-btn" onclick="switchTab('bookings')">
                <i class="fas fa-calendar-check"></i> Bookings
            </button>
            <button class="tab-btn" onclick="switchTab('brands')">
                <i class="fas fa-tag"></i> Brands & Models
            </button>
        </div>
        
        <!-- Cars Tab -->
        <div id="tab-cars" class="tab-content active">
            <div class="admin-section-header">
                <h2>Cars Management</h2>
                <button class="btn btn-primary" onclick="showAddCarModal()">
                    <i class="fas fa-plus"></i> Add New Car
                </button>
            </div>
            <div id="cars-container">
                <div class="loading">Loading cars...</div>
            </div>
        </div>
        
        <!-- Bookings Tab -->
        <div id="tab-bookings" class="tab-content">
            <div class="admin-section-header">
                <h2>All Bookings</h2>
            </div>
            <div id="bookings-container">
                <div class="loading">Loading bookings...</div>
            </div>
        </div>
        
        <!-- Brands & Models Tab -->
        <div id="tab-brands" class="tab-content">
            <div class="admin-section-header">
                <h2>Brands & Models Management</h2>
                <div>
                    <button class="btn btn-primary" onclick="showAddBrandModal()">
                        <i class="fas fa-plus"></i> Add Brand
                    </button>
                    <button class="btn btn-primary" onclick="showAddModelModal()">
                        <i class="fas fa-plus"></i> Add Model
                    </button>
                </div>
            </div>
            <div id="brands-container">
                <div class="loading">Loading brands and models...</div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Car Modal -->
<div id="carModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2 id="modal-title">Add New Car</h2>
            <span class="close" onclick="closeCarModal()">&times;</span>
        </div>
        <form id="carForm" onsubmit="saveCar(event)">
            <input type="hidden" id="car_id" name="car_id">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Brand <span class="required">*</span></label>
                    <select id="car_brand" name="brand_id" required onchange="loadModels()">
                        <option value="">Select Brand</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Model <span class="required">*</span></label>
                    <select id="car_model" name="model_id" required>
                        <option value="">Select Model</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Car Type <span class="required">*</span></label>
                    <select id="car_type" name="carType_id" required>
                        <option value="">Select Car Type</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fuel Type <span class="required">*</span></label>
                    <select id="fuel_type" name="fuel_type" required onchange="toggleFuelFields()">
                        <option value="">Select Fuel Type</option>
                        <option value="Petrol">Petrol</option>
                        <option value="Diesel">Diesel</option>
                        <option value="Electric">Electric</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Daily Rate (RM) <span class="required">*</span></label>
                    <input type="number" id="car_rate" name="rate" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Colour</label>
                    <input type="text" id="car_colour" name="colour">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Doors</label>
                    <input type="number" id="car_door" name="door" min="0">
                </div>
                <div class="form-group">
                    <label>Seats</label>
                    <input type="number" id="car_seat" name="seat" min="0">
                </div>
                <div class="form-group">
                    <label>Bags (Suitcase)</label>
                    <input type="number" id="car_suitcase" name="suitcase" min="0">
                </div>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="car_description" name="description" rows="3"></textarea>
            </div>
            
            <!-- Fuel Type Specific Fields -->
            <div id="petrol-fields" class="fuel-fields" style="display: none;">
                <h3>Petrol Specifications</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Octane Rating</label>
                        <input type="number" id="octane_rating" name="octane_rating" min="0">
                    </div>
                    <div class="form-group">
                        <label>Fuel Tank Capacity (L)</label>
                        <input type="number" id="petrol_tank" name="fuel_tank_capacity" step="0.01" min="0">
                    </div>
                </div>
            </div>
            
            <div id="diesel-fields" class="fuel-fields" style="display: none;">
                <h3>Diesel Specifications</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Diesel Emission</label>
                        <input type="text" id="diesel_emission" name="diesel_emission">
                    </div>
                    <div class="form-group">
                        <label>Fuel Tank Capacity (L)</label>
                        <input type="number" id="diesel_tank" name="fuel_tank_capacity" step="0.01" min="0">
                    </div>
                </div>
            </div>
            
            <div id="electric-fields" class="fuel-fields" style="display: none;">
                <h3>Electric Specifications</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Battery Range (km)</label>
                        <input type="number" id="battery_range" name="battery_range" min="0">
                    </div>
                    <div class="form-group">
                        <label>Charging Rate (kW)</label>
                        <input type="number" id="charging_rate" name="charging_rate_kw" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Last Charging Date</label>
                        <input type="date" id="last_charging_date" name="last_charging_date">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Pickup Locations (comma-separated)</label>
                <input type="text" id="pickup_location" name="pickup_location" placeholder="KLIA, KLIA2, KL Sentral">
            </div>
            
            <div class="form-group">
                <label>Drop-off Locations (comma-separated)</label>
                <input type="text" id="dropoff_location" name="dropoff_location" placeholder="KLIA, KLIA2, KL Sentral">
            </div>
            
            <div class="form-group">
                <label>Available Locations (comma-separated)</label>
                <input type="text" id="available_locations" name="available_locations" placeholder="Kuala Lumpur, Selangor">
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="allows_different_dropoff" name="allows_different_dropoff" value="1" checked>
                    Allow Different Drop-off Location
                </label>
            </div>
            
            <div class="form-group">
                <label>Car Image</label>
                <input type="file" id="car_image" name="attachments" accept="image/*" onchange="previewImage(event)">
                <div id="image-preview" style="margin-top: 10px;"></div>
                <div id="current-image" style="margin-top: 10px;"></div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCarModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Car</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Brand Modal -->
<div id="brandModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Brand</h2>
            <span class="close" onclick="closeBrandModal()">&times;</span>
        </div>
        <form onsubmit="saveBrand(event)">
            <div class="form-group">
                <label>Brand Name <span class="required">*</span></label>
                <input type="text" id="brand_name" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBrandModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Brand</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Model Modal -->
<div id="modelModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Model</h2>
            <span class="close" onclick="closeModelModal()">&times;</span>
        </div>
        <form onsubmit="saveModel(event)">
            <div class="form-group">
                <label>Brand <span class="required">*</span></label>
                <select id="model_brand" required>
                    <option value="">Select Brand</option>
                </select>
            </div>
            <div class="form-group">
                <label>Model Name <span class="required">*</span></label>
                <input type="text" id="model_name" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModelModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Model</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentTab = 'cars';
    let allBrands = [];
    let allModels = [];
    let allCarTypes = [];
    
    // Tab switching
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        if (tab === 'cars') {
            loadCars();
        } else if (tab === 'bookings') {
            loadBookings();
        } else if (tab === 'brands') {
            loadBrandsAndModels();
        }
    }
    
    // Load initial data
    function initAdmin() {
        loadFilters();
        loadCars();
    }
    
    // Load filters data
    function loadFilters() {
        fetch('/api/filters')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    allBrands = data.brands;
                    allCarTypes = data.types;
                    
                    // Populate brand dropdowns
                    const brandSelects = document.querySelectorAll('#car_brand, #model_brand');
                    brandSelects.forEach(select => {
                        select.innerHTML = '<option value="">Select Brand</option>';
                        data.brands.forEach(brand => {
                            const option = document.createElement('option');
                            option.value = brand.BRAND_ID;
                            option.textContent = brand.BRAND_NAME;
                            select.appendChild(option);
                        });
                    });
                    
                    // Populate car type dropdown
                    const carTypeSelect = document.getElementById('car_type');
                    carTypeSelect.innerHTML = '<option value="">Select Car Type</option>';
                    data.types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.CARTYPE_ID;
                        option.textContent = type.CARTYPE_NAME;
                        carTypeSelect.appendChild(option);
                    });
                }
            });
    }
    
    // Load models for selected brand
    function loadModels() {
        const brandId = document.getElementById('car_brand').value;
        const modelSelect = document.getElementById('car_model');
        modelSelect.innerHTML = '<option value="">Select Model</option>';
        
        if (brandId) {
            fetch(`/api/models?brand_id=${brandId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.MODEL_ID;
                            option.textContent = model.MODEL_NAME;
                            modelSelect.appendChild(option);
                        });
                    }
                });
        }
    }
    
    // Toggle fuel type fields
    function toggleFuelFields() {
        const fuelType = document.getElementById('fuel_type').value;
        document.getElementById('petrol-fields').style.display = fuelType === 'Petrol' ? 'block' : 'none';
        document.getElementById('diesel-fields').style.display = fuelType === 'Diesel' ? 'block' : 'none';
        document.getElementById('electric-fields').style.display = fuelType === 'Electric' ? 'block' : 'none';
    }
    
    // Load cars
    function loadCars() {
        fetch('/api/admin/cars')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('cars-container');
                if (data.success) {
                    const cars = data.cars;
                    if (cars.length === 0) {
                        container.innerHTML = '<p class="no-results">No cars found.</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="admin-table-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Car</th>
                                        <th>Type</th>
                                        <th>Fuel</th>
                                        <th>Rate</th>
                                        <th>Seats/Bags</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cars.map(car => `
                                        <tr>
                                            <td>#${car.CAR_ID}</td>
                                            <td>
                                                <strong>${car.BRAND_NAME} ${car.MODEL_NAME}</strong><br>
                                                <small>${car.COLOUR || 'N/A'}</small>
                                            </td>
                                            <td>${car.CARTYPE_NAME}</td>
                                            <td>${car.FUEL_TYPE || 'N/A'}</td>
                                            <td>RM ${parseFloat(car.RATE).toFixed(2)}</td>
                                            <td>${car.SEAT || 0} Seats / ${car.SUITCASE || 0} Bags</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary" onclick="editCar(${car.CAR_ID})">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteCar(${car.CAR_ID})">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<p class="error">${data.message}</p>`;
                }
            })
            .catch(err => {
                document.getElementById('cars-container').innerHTML = '<p class="error">Failed to load cars.</p>';
            });
    }
    
    // Show add car modal
    function showAddCarModal() {
        document.getElementById('modal-title').textContent = 'Add New Car';
        document.getElementById('carForm').reset();
        document.getElementById('car_id').value = '';
        document.getElementById('image-preview').innerHTML = '';
        document.getElementById('current-image').innerHTML = '';
        toggleFuelFields();
        document.getElementById('carModal').style.display = 'block';
    }
    
    // Edit car
    function editCar(carId) {
        fetch(`/api/admin/car/${carId}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const car = data.car;
                    document.getElementById('modal-title').textContent = 'Edit Car';
                    document.getElementById('car_id').value = car.CAR_ID;
                    document.getElementById('car_brand').value = car.BRAND_ID;
                    loadModels();
                    setTimeout(() => {
                        document.getElementById('car_model').value = car.MODEL_ID;
                    }, 500);
                    document.getElementById('car_type').value = car.CARTYPE_ID;
                    document.getElementById('fuel_type').value = car.FUEL_TYPE || '';
                    document.getElementById('car_rate').value = car.RATE;
                    document.getElementById('car_colour').value = car.COLOUR || '';
                    document.getElementById('car_door').value = car.DOOR || '';
                    document.getElementById('car_seat').value = car.SEAT || '';
                    document.getElementById('car_suitcase').value = car.SUITCASE || '';
                    document.getElementById('car_description').value = car.DESCRIPTION || '';
                    document.getElementById('pickup_location').value = car.PICKUP_LOCATION || '';
                    document.getElementById('dropoff_location').value = car.DROPOFF_LOCATION || '';
                    document.getElementById('available_locations').value = car.AVAILABLE_LOCATIONS || '';
                    document.getElementById('allows_different_dropoff').checked = car.ALLOWS_DIFFERENT_DROPOFF == 1;
                    
                    // Fuel type specific fields
                    if (car.FUEL_TYPE === 'Petrol') {
                        document.getElementById('octane_rating').value = car.OCTANE_RATING || '';
                        document.getElementById('petrol_tank').value = car.PETROL_TANK || '';
                    } else if (car.FUEL_TYPE === 'Diesel') {
                        document.getElementById('diesel_emission').value = car.DIESEL_EMISSION || '';
                        document.getElementById('diesel_tank').value = car.DIESEL_TANK || '';
                    } else if (car.FUEL_TYPE === 'Electric') {
                        document.getElementById('battery_range').value = car.BATTERY_RANGE || '';
                        document.getElementById('charging_rate').value = car.CHARGING_RATE_KW || '';
                        if (car.LAST_CHARGING_DATE) {
                            const date = new Date(car.LAST_CHARGING_DATE);
                            document.getElementById('last_charging_date').value = date.toISOString().split('T')[0];
                        }
                    }
                    
                    toggleFuelFields();
                    
                    // Show current image if exists
                    if (car.ATTACHMENTS) {
                        document.getElementById('current-image').innerHTML = `
                            <p>Current Image:</p>
                            <img src="/uploads/${car.ATTACHMENTS}" style="max-width: 200px; height: auto;">
                        `;
                    }
                    
                    document.getElementById('carModal').style.display = 'block';
                }
            });
    }
    
    // Delete car
    function deleteCar(carId) {
        if (!confirm('Are you sure you want to delete this car? This action cannot be undone.')) {
            return;
        }
        
        fetch(`/api/admin/car/${carId}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Car deleted successfully!');
                    loadCars();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    // Save car
    function saveCar(event) {
        event.preventDefault();
        const formData = new FormData(document.getElementById('carForm'));
        const carId = document.getElementById('car_id').value;
        
        fetch(`/api/admin/car${carId ? '/' + carId : ''}`, {
            method: carId ? 'PUT' : 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(carId ? 'Car updated successfully!' : 'Car added successfully!');
                    closeCarModal();
                    loadCars();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(err => {
                alert('Error: ' + err.message);
            });
    }
    
    // Close car modal
    function closeCarModal() {
        document.getElementById('carModal').style.display = 'none';
    }
    
    // Image preview
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').innerHTML = `
                    <p>New Image Preview:</p>
                    <img src="${e.target.result}" style="max-width: 200px; height: auto;">
                `;
            };
            reader.readAsDataURL(file);
        }
    }
    
    // Load bookings
    function loadBookings() {
        fetch('/api/my-bookings')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('bookings-container');
                if (data.success) {
                    const bookings = data.bookings;
                    if (bookings.length === 0) {
                        container.innerHTML = '<p class="no-results">No bookings found.</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="admin-table-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Customer</th>
                                        <th>Car</th>
                                        <th>Pickup Date</th>
                                        <th>Drop-off Date</th>
                                        <th>Pickup Location</th>
                                        <th>Drop-off Location</th>
                                        <th>Price</th>
                                        <th>Payment Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${bookings.map(booking => {
                                        const pickupDate = new Date(booking.PICKUP_DATE);
                                        const dropoffDate = new Date(booking.DROPOFF_DATE);
                                        const isPaid = booking.PAYMENT_STATUS === 'Paid';
                                        return `
                                            <tr>
                                                <td>#${booking.BOOKING_ID}</td>
                                                <td>
                                                    ${booking.CUSTOMER_NAME || 'N/A'}<br>
                                                    <small>${booking.CUST_EMAIL || ''}</small><br>
                                                    <small>${booking.CUST_PHONE || ''}</small>
                                                </td>
                                                <td>${booking.BRAND_NAME} ${booking.MODEL_NAME}</td>
                                                <td>${pickupDate.toLocaleDateString()}</td>
                                                <td>${dropoffDate.toLocaleDateString()}</td>
                                                <td>${booking.PICKUP_LOCATION || 'N/A'}</td>
                                                <td>${booking.DROPOFF_LOCATION || 'N/A'}</td>
                                                <td>RM ${parseFloat(booking.PRICE).toFixed(2)}</td>
                                                <td>
                                                    <select class="payment-status-select" 
                                                            data-booking-id="${booking.BOOKING_ID}"
                                                            onchange="updatePaymentStatus(${booking.BOOKING_ID}, this.value)"
                                                            style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); font-size: 0.9rem; cursor: pointer;">
                                                        <option value="Pending" ${!isPaid ? 'selected' : ''}>Pending</option>
                                                        <option value="Paid" ${isPaid ? 'selected' : ''}>Paid</option>
                                                    </select>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<p class="error">${data.message}</p>`;
                }
            });
    }
    
    // Load brands and models
    function loadBrandsAndModels() {
        Promise.all([
            fetch('/api/filters').then(res => res.json()),
            fetch('/api/admin/models').then(res => res.json())
        ])
            .then(([brandsData, modelsData]) => {
                if (brandsData.success && modelsData.success) {
                    const container = document.getElementById('brands-container');
                    
                    // Group models by brand
                    const modelsByBrand = {};
                    modelsData.models.forEach(model => {
                        const brandId = model.BRAND_ID;
                        if (!modelsByBrand[brandId]) {
                            modelsByBrand[brandId] = [];
                        }
                        modelsByBrand[brandId].push(model);
                    });
                    
                    container.innerHTML = `
                        <div class="brands-section">
                            <h3>Brands</h3>
                            <div class="admin-table-container">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Brand Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${brandsData.brands.map(brand => `
                                            <tr>
                                                <td>#${brand.BRAND_ID}</td>
                                                <td>${brand.BRAND_NAME}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="models-section" style="margin-top: 2rem;">
                            <h3>Models</h3>
                            <div class="admin-table-container">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Model Name</th>
                                            <th>Brand</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${modelsData.models.map(model => `
                                            <tr>
                                                <td>#${model.MODEL_ID}</td>
                                                <td>${model.MODEL_NAME}</td>
                                                <td>${model.BRAND_NAME}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('brands-container').innerHTML = '<p class="error">Failed to load data.</p>';
                }
            })
            .catch(err => {
                document.getElementById('brands-container').innerHTML = '<p class="error">Failed to load brands and models.</p>';
            });
    }
    
    // Brand and Model modals
    function showAddBrandModal() {
        document.getElementById('brand_name').value = '';
        document.getElementById('brandModal').style.display = 'block';
    }
    
    function closeBrandModal() {
        document.getElementById('brandModal').style.display = 'none';
    }
    
    function saveBrand(event) {
        event.preventDefault();
        fetch('/api/admin/brand', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({brand_name: document.getElementById('brand_name').value})
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Brand added successfully!');
                    closeBrandModal();
                    loadFilters();
                    loadBrandsAndModels();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    function showAddModelModal() {
        document.getElementById('model_name').value = '';
        document.getElementById('model_brand').value = '';
        document.getElementById('modelModal').style.display = 'block';
    }
    
    function closeModelModal() {
        document.getElementById('modelModal').style.display = 'none';
    }
    
    function saveModel(event) {
        event.preventDefault();
        fetch('/api/admin/model', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                model_name: document.getElementById('model_name').value,
                brand_id: document.getElementById('model_brand').value
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Model added successfully!');
                    closeModelModal();
                    loadFilters();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    // Update payment status
    function updatePaymentStatus(bookingId, status) {
        if (!confirm(`Are you sure you want to change payment status to "${status}"?`)) {
            // Reload to reset dropdown
            loadBookings();
            return;
        }
        
        fetch('/api/admin/booking/payment-status', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                booking_id: bookingId,
                payment_status: status
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Payment status updated successfully!');
                    loadBookings();
                } else {
                    alert('Error: ' + data.message);
                    loadBookings();
                }
            })
            .catch(err => {
                alert('Error: ' + err.message);
                loadBookings();
            });
    }
    
    // Initialize on page load
    initAdmin();
</script>
{% endblock %}
