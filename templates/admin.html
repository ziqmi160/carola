{% extends "base.html" %}

{% block title %}Admin Dashboard - Carola Car Rental{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="container">
        <h1 class="page-title">Admin Dashboard</h1>
        <p class="page-subtitle">Manage cars, bookings, and system data</p>
        
        <!-- Tabs -->
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-line"></i> Dashboard
            </button>
            <button class="tab-btn" onclick="switchTab('cars')">
                <i class="fas fa-car"></i> Cars Management
            </button>
            <button class="tab-btn" onclick="switchTab('bookings')">
                <i class="fas fa-calendar-check"></i> Bookings
            </button>
            <button class="tab-btn" onclick="switchTab('brands')">
                <i class="fas fa-tag"></i> Brands & Models
            </button>
            <button class="tab-btn" id="staff-tab-btn" onclick="switchTab('staff')" style="display: none;">
                <i class="fas fa-users"></i> Staff Management
            </button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="dashboard-stats">
                <div class="stat-card revenue">
                    <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="stat-info">
                        <h3 id="stat-revenue">RM 0.00</h3>
                        <p>Total Revenue</p>
                    </div>
                </div>
                <div class="stat-card monthly">
                    <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                    <div class="stat-info">
                        <h3 id="stat-monthly">RM 0.00</h3>
                        <p>This Month</p>
                    </div>
                </div>
                <div class="stat-card bookings">
                    <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
                    <div class="stat-info">
                        <h3 id="stat-bookings">0</h3>
                        <p>Total Bookings</p>
                    </div>
                </div>
                <div class="stat-card customers">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-info">
                        <h3 id="stat-customers">0</h3>
                        <p>Customers</p>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-row">
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-bar"></i> Popular Brands</h3>
                    <div class="chart-container">
                        <canvas id="brandsChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-line"></i> Revenue Trend</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-row">
                <div class="dashboard-card wide">
                    <h3><i class="fas fa-clock"></i> Recent Bookings</h3>
                    <div id="recent-bookings-container">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-info-circle"></i> Booking Status</h3>
                    <div class="booking-status-summary">
                        <div class="status-item paid">
                            <span class="status-count" id="stat-paid">0</span>
                            <span class="status-label">Paid</span>
                        </div>
                        <div class="status-item pending">
                            <span class="status-count" id="stat-pending">0</span>
                            <span class="status-label">Pending</span>
                        </div>
                        <div class="status-item cars">
                            <span class="status-count" id="stat-cars">0</span>
                            <span class="status-label">Cars</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cars Tab -->
        <div id="tab-cars" class="tab-content">
            <div class="admin-section-header">
                <h2>Cars Management</h2>
                <button class="btn btn-primary" onclick="showAddCarModal()">
                    <i class="fas fa-plus"></i> Add New Car
                </button>
            </div>
            
            <!-- Search & Filter Section -->
            <div class="admin-filters">
                <div class="filter-row">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="car-search" placeholder="Search by brand, model, colour..." oninput="filterCars()">
                    </div>
                    <div class="filter-select">
                        <select id="filter-brand" onchange="filterCars()">
                            <option value="">All Brands</option>
                        </select>
                    </div>
                    <div class="filter-select">
                        <select id="filter-type" onchange="filterCars()">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    <div class="filter-select">
                        <select id="filter-fuel" onchange="filterCars()">
                            <option value="">All Fuel Types</option>
                            <option value="Petrol">Petrol</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Electric">Electric</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                <div class="filter-results">
                    <span id="cars-count">0 cars found</span>
                </div>
            </div>
            
            <div id="cars-container">
                <div class="loading">Loading cars...</div>
            </div>
        </div>
        
        <!-- Bookings Tab -->
        <div id="tab-bookings" class="tab-content">
            <div class="admin-section-header">
                <h2>All Bookings</h2>
            </div>
            <div id="bookings-container">
                <div class="loading">Loading bookings...</div>
            </div>
        </div>
        
        <!-- Brands & Models Tab -->
        <div id="tab-brands" class="tab-content">
            <div class="admin-section-header">
                <h2>Brands & Models Management</h2>
                <div>
                    <button class="btn btn-primary" onclick="showAddBrandModal()">
                        <i class="fas fa-plus"></i> Add Brand
                    </button>
                    <button class="btn btn-primary" onclick="showAddModelModal()">
                        <i class="fas fa-plus"></i> Add Model
                    </button>
                </div>
            </div>
            <div id="brands-container">
                <div class="loading">Loading brands and models...</div>
            </div>
        </div>
        
        <!-- Staff Management Tab (Only for Managers) -->
        <div id="tab-staff" class="tab-content">
            <div class="admin-section-header">
                <h2>Staff Management</h2>
                <button class="btn btn-primary" onclick="showAddStaffModal()">
                    <i class="fas fa-plus"></i> Add New Staff
                </button>
            </div>
            <div id="staff-container">
                <div class="loading">Loading staff...</div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Car Modal -->
<div id="carModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2 id="modal-title">Add New Car</h2>
            <span class="close" onclick="closeCarModal()">&times;</span>
        </div>
        <form id="carForm" onsubmit="saveCar(event)">
            <input type="hidden" id="car_id" name="car_id">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Brand <span class="required">*</span></label>
                    <select id="car_brand" name="brand_id" required onchange="loadModels()">
                        <option value="">Select Brand</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Model <span class="required">*</span></label>
                    <select id="car_model" name="model_id" required>
                        <option value="">Select Model</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Car Type <span class="required">*</span></label>
                    <select id="car_type" name="carType_id" required>
                        <option value="">Select Car Type</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fuel Type <span class="required">*</span></label>
                    <select id="fuel_type" name="fuel_type" required onchange="toggleFuelFields()">
                        <option value="">Select Fuel Type</option>
                        <option value="Petrol">Petrol</option>
                        <option value="Diesel">Diesel</option>
                        <option value="Electric">Electric</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Daily Rate (RM) <span class="required">*</span></label>
                    <input type="number" id="car_rate" name="rate" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Colour</label>
                    <input type="text" id="car_colour" name="colour">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Doors</label>
                    <input type="number" id="car_door" name="door" min="0">
                </div>
                <div class="form-group">
                    <label>Seats</label>
                    <input type="number" id="car_seat" name="seat" min="0">
                </div>
                <div class="form-group">
                    <label>Bags (Suitcase)</label>
                    <input type="number" id="car_suitcase" name="suitcase" min="0">
                </div>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="car_description" name="description" rows="3"></textarea>
            </div>
            
            <!-- Fuel Type Specific Fields -->
            <div id="petrol-fields" class="fuel-fields" style="display: none;">
                <h3>Petrol Specifications</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Octane Rating</label>
                        <input type="number" id="octane_rating" name="octane_rating" min="0">
                    </div>
                    <div class="form-group">
                        <label>Fuel Tank Capacity (L)</label>
                        <input type="number" id="petrol_tank" name="fuel_tank_capacity" step="0.01" min="0">
                    </div>
                </div>
            </div>
            
            <div id="diesel-fields" class="fuel-fields" style="display: none;">
                <h3>Diesel Specifications</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Diesel Emission</label>
                        <input type="text" id="diesel_emission" name="diesel_emission">
                    </div>
                    <div class="form-group">
                        <label>Fuel Tank Capacity (L)</label>
                        <input type="number" id="diesel_tank" name="fuel_tank_capacity" step="0.01" min="0">
                    </div>
                </div>
            </div>
            
            <div id="electric-fields" class="fuel-fields" style="display: none;">
                <h3>Electric Specifications</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Battery Range (km)</label>
                        <input type="number" id="battery_range" name="battery_range" min="0">
                    </div>
                    <div class="form-group">
                        <label>Charging Rate (kW)</label>
                        <input type="number" id="charging_rate" name="charging_rate_kw" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Last Charging Date</label>
                        <input type="date" id="last_charging_date" name="last_charging_date">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Pickup Locations (comma-separated)</label>
                <input type="text" id="pickup_location" name="pickup_location" placeholder="KLIA, KLIA2, KL Sentral">
            </div>
            
            <div class="form-group">
                <label>Drop-off Locations (comma-separated)</label>
                <input type="text" id="dropoff_location" name="dropoff_location" placeholder="KLIA, KLIA2, KL Sentral">
            </div>
            
            <div class="form-group">
                <label>Available Locations (comma-separated)</label>
                <input type="text" id="available_locations" name="available_locations" placeholder="Kuala Lumpur, Selangor">
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="allows_different_dropoff" name="allows_different_dropoff" value="1" checked>
                    Allow Different Drop-off Location
                </label>
            </div>
            
            <div class="form-group">
                <label>Car Image</label>
                <input type="file" id="car_image" name="attachments" accept="image/*" onchange="previewImage(event)">
                <div id="image-preview" style="margin-top: 10px;"></div>
                <div id="current-image" style="margin-top: 10px;"></div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCarModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Car</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Brand Modal -->
<div id="brandModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="brand-modal-title">Add New Brand</h2>
            <span class="close" onclick="closeBrandModal()">&times;</span>
        </div>
        <form onsubmit="saveBrand(event)">
            <input type="hidden" id="edit_brand_id">
            <div class="form-group">
                <label>Brand Name <span class="required">*</span></label>
                <input type="text" id="brand_name" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBrandModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Brand</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Model Modal -->
<div id="modelModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="model-modal-title">Add New Model</h2>
            <span class="close" onclick="closeModelModal()">&times;</span>
        </div>
        <form onsubmit="saveModel(event)">
            <input type="hidden" id="edit_model_id">
            <div class="form-group">
                <label>Brand <span class="required">*</span></label>
                <select id="model_brand" required>
                    <option value="">Select Brand</option>
                </select>
            </div>
            <div class="form-group">
                <label>Model Name <span class="required">*</span></label>
                <input type="text" id="model_name" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModelModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Model</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Staff Modal -->
<div id="staffModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="staff-modal-title">Add New Staff</h2>
            <span class="close" onclick="closeStaffModal()">&times;</span>
        </div>
        <form onsubmit="saveStaff(event)">
            <input type="hidden" id="edit_staff_id">
            <div class="form-row">
                <div class="form-group">
                    <label>First Name <span class="required">*</span></label>
                    <input type="text" id="staff_fname" required>
                </div>
                <div class="form-group">
                    <label>Last Name <span class="required">*</span></label>
                    <input type="text" id="staff_lname" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="staff_email" required>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="staff_phone">
                </div>
            </div>
            <div class="form-group">
                <label>Department</label>
                <input type="text" id="staff_dept" placeholder="e.g. Sales, Operations, Customer Service">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" id="staff_username" required>
                </div>
                <div class="form-group">
                    <label>Password <span class="required" id="password-required">*</span></label>
                    <input type="password" id="staff_password" required minlength="8">
                    <small class="password-requirement">Min 8 characters with at least one number</small>
                    <small id="password-hint" style="display: none; color: var(--text-secondary);">Leave blank to keep current password</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeStaffModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Staff</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* Dashboard Styles */
.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-card .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.stat-card.revenue .stat-icon { background: linear-gradient(135deg, #10b981, #059669); }
.stat-card.monthly .stat-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.stat-card.bookings .stat-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
.stat-card.customers .stat-icon { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }

.stat-card .stat-info h3 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    color: var(--text-primary);
}

.stat-card .stat-info p {
    margin: 0.25rem 0 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.dashboard-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.dashboard-card {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: var(--shadow);
}

.dashboard-card.wide {
    grid-column: span 1;
}

.dashboard-card h3 {
    margin: 0 0 1rem;
    font-size: 1.1rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.dashboard-card h3 i {
    color: var(--primary-color);
}

.chart-container {
    height: 250px;
}

.booking-status-summary {
    display: flex;
    justify-content: space-around;
    padding: 1rem 0;
}

.status-item {
    text-align: center;
}

.status-item .status-count {
    display: block;
    font-size: 2rem;
    font-weight: 700;
}

.status-item .status-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.status-item.paid .status-count { color: #10b981; }
.status-item.pending .status-count { color: #f59e0b; }
.status-item.cars .status-count { color: #3b82f6; }

.recent-booking-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}

.recent-booking-item:last-child {
    border-bottom: none;
}

.recent-booking-info {
    flex: 1;
}

.recent-booking-info strong {
    display: block;
    color: var(--text-primary);
}

.recent-booking-info small {
    color: var(--text-secondary);
}

.recent-booking-price {
    font-weight: 600;
    color: var(--primary-color);
}

.recent-booking-status {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 1rem;
}

.recent-booking-status.paid {
    background: #d1fae5;
    color: #059669;
}

.recent-booking-status.pending {
    background: #fef3c7;
    color: #d97706;
}

@media (max-width: 768px) {
    .dashboard-row {
        grid-template-columns: 1fr;
    }
    .dashboard-card.wide {
        grid-column: span 1;
    }
}

.admin-filters {
    background: var(--card-bg);
    padding: 1.25rem;
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
}

.filter-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
}

.search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 2px solid var(--border-color);
    border-radius: 0.5rem;
    font-size: 0.95rem;
    transition: border-color 0.3s;
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.filter-select select {
    padding: 0.75rem 2rem 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 0.5rem;
    font-size: 0.95rem;
    background: white;
    cursor: pointer;
    min-width: 150px;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
}

.filter-select select:focus {
    outline: none;
    border-color: var(--primary-color);
}

.filter-results {
    margin-top: 0.75rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.filter-results span {
    font-weight: 600;
    color: var(--primary-color);
}

@media (max-width: 768px) {
    .filter-row {
        flex-direction: column;
    }
    .search-box, .filter-select {
        width: 100%;
    }
    .filter-select select {
        width: 100%;
    }
}
</style>

<script>
    let currentTab = 'cars';
    let allBrands = [];
    let allModels = [];
    let allCarTypes = [];
    let allCars = [];
    
    // Tab switching
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        if (tab === 'dashboard') {
            loadDashboard();
        } else if (tab === 'cars') {
            loadCars();
        } else if (tab === 'bookings') {
            loadBookings();
        } else if (tab === 'brands') {
            loadBrandsAndModels();
        } else if (tab === 'staff') {
            loadStaff();
        }
    }
    
    // Dashboard charts
    let brandsChart = null;
    let revenueChart = null;
    
    // Load dashboard stats
    function loadDashboard() {
        fetch('/api/admin/stats')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    
                    // Update stat cards
                    document.getElementById('stat-revenue').textContent = 'RM ' + stats.total_revenue.toLocaleString('en-MY', {minimumFractionDigits: 2});
                    document.getElementById('stat-monthly').textContent = 'RM ' + stats.monthly_revenue.toLocaleString('en-MY', {minimumFractionDigits: 2});
                    document.getElementById('stat-bookings').textContent = stats.total_bookings;
                    document.getElementById('stat-customers').textContent = stats.total_customers;
                    document.getElementById('stat-paid').textContent = stats.paid_bookings;
                    document.getElementById('stat-pending').textContent = stats.pending_bookings;
                    document.getElementById('stat-cars').textContent = stats.total_cars;
                    
                    // Render Popular Brands Chart
                    const brandsCtx = document.getElementById('brandsChart').getContext('2d');
                    if (brandsChart) brandsChart.destroy();
                    brandsChart = new Chart(brandsCtx, {
                        type: 'bar',
                        data: {
                            labels: stats.popular_brands.map(b => b.name),
                            datasets: [{
                                label: 'Bookings',
                                data: stats.popular_brands.map(b => b.count),
                                backgroundColor: ['#EF4444', '#F87171', '#1a1a1a', '#374151', '#6B7280'],
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { stepSize: 1 } }
                            }
                        }
                    });
                    
                    // Render Revenue Trend Chart
                    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                    if (revenueChart) revenueChart.destroy();
                    revenueChart = new Chart(revenueCtx, {
                        type: 'line',
                        data: {
                            labels: stats.monthly_trend.map(m => m.month),
                            datasets: [{
                                label: 'Revenue (RM)',
                                data: stats.monthly_trend.map(m => m.revenue),
                                borderColor: '#EF4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#EF4444'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                    
                    // Render Recent Bookings
                    const recentContainer = document.getElementById('recent-bookings-container');
                    if (stats.recent_bookings.length === 0) {
                        recentContainer.innerHTML = '<p style="color: var(--text-secondary);">No bookings yet.</p>';
                    } else {
                        recentContainer.innerHTML = stats.recent_bookings.map(booking => {
                            const date = new Date(booking.pickup_date);
                            return `
                                <div class="recent-booking-item">
                                    <div class="recent-booking-info">
                                        <strong>${booking.car_name}</strong>
                                        <small>${booking.customer_name} â€¢ ${date.toLocaleDateString('en-GB')}</small>
                                    </div>
                                    <span class="recent-booking-price">RM ${booking.price.toFixed(2)}</span>
                                    <span class="recent-booking-status ${booking.status.toLowerCase()}">${booking.status}</span>
                                </div>
                            `;
                        }).join('');
                    }
                }
            })
            .catch(err => {
                console.error('Error loading dashboard:', err);
            });
    }
    
    // Load initial data
    function initAdmin() {
        loadFilters();
        loadDashboard(); // Load dashboard first
    }
    
    // Load filters data
    function loadFilters() {
        fetch('/api/filters')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    allBrands = data.brands;
                    allCarTypes = data.types;
                    
                    // Populate brand dropdowns (form)
                    const brandSelects = document.querySelectorAll('#car_brand, #model_brand');
                    brandSelects.forEach(select => {
                        select.innerHTML = '<option value="">Select Brand</option>';
                        data.brands.forEach(brand => {
                            const option = document.createElement('option');
                            option.value = brand.BRAND_ID;
                            option.textContent = brand.BRAND_NAME;
                            select.appendChild(option);
                        });
                    });
                    
                    // Populate filter brand dropdown
                    const filterBrand = document.getElementById('filter-brand');
                    filterBrand.innerHTML = '<option value="">All Brands</option>';
                    data.brands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand.BRAND_NAME;
                        option.textContent = brand.BRAND_NAME;
                        filterBrand.appendChild(option);
                    });
                    
                    // Populate car type dropdown (form)
                    const carTypeSelect = document.getElementById('car_type');
                    carTypeSelect.innerHTML = '<option value="">Select Car Type</option>';
                    data.types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.CARTYPE_ID;
                        option.textContent = type.CARTYPE_NAME;
                        carTypeSelect.appendChild(option);
                    });
                    
                    // Populate filter type dropdown
                    const filterType = document.getElementById('filter-type');
                    filterType.innerHTML = '<option value="">All Types</option>';
                    data.types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.CARTYPE_NAME;
                        option.textContent = type.CARTYPE_NAME;
                        filterType.appendChild(option);
                    });
                }
            });
    }
    
    // Load models for selected brand
    function loadModels() {
        const brandId = document.getElementById('car_brand').value;
        const modelSelect = document.getElementById('car_model');
        modelSelect.innerHTML = '<option value="">Select Model</option>';
        
        if (brandId) {
            fetch(`/api/models?brand_id=${brandId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.MODEL_ID;
                            option.textContent = model.MODEL_NAME;
                            modelSelect.appendChild(option);
                        });
                    }
                });
        }
    }
    
    // Toggle fuel type fields
    function toggleFuelFields() {
        const fuelType = document.getElementById('fuel_type').value;
        document.getElementById('petrol-fields').style.display = fuelType === 'Petrol' ? 'block' : 'none';
        document.getElementById('diesel-fields').style.display = fuelType === 'Diesel' ? 'block' : 'none';
        document.getElementById('electric-fields').style.display = fuelType === 'Electric' ? 'block' : 'none';
    }
    
    // Load cars
    function loadCars() {
        fetch('/api/admin/cars')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    allCars = data.cars;
                    filterCars();
                } else {
                    document.getElementById('cars-container').innerHTML = `<p class="error">${data.message}</p>`;
                }
            })
            .catch(err => {
                document.getElementById('cars-container').innerHTML = '<p class="error">Failed to load cars.</p>';
            });
    }
    
    // Filter cars
    function filterCars() {
        const searchTerm = document.getElementById('car-search').value.toLowerCase();
        const brandFilter = document.getElementById('filter-brand').value;
        const typeFilter = document.getElementById('filter-type').value;
        const fuelFilter = document.getElementById('filter-fuel').value;
        
        let filteredCars = allCars.filter(car => {
            const searchMatch = !searchTerm || 
                car.BRAND_NAME.toLowerCase().includes(searchTerm) ||
                car.MODEL_NAME.toLowerCase().includes(searchTerm) ||
                (car.COLOUR && car.COLOUR.toLowerCase().includes(searchTerm)) ||
                car.CAR_ID.toString().includes(searchTerm);
            const brandMatch = !brandFilter || car.BRAND_NAME === brandFilter;
            const typeMatch = !typeFilter || car.CARTYPE_NAME === typeFilter;
            const fuelMatch = !fuelFilter || car.FUEL_TYPE === fuelFilter;
            return searchMatch && brandMatch && typeMatch && fuelMatch;
        });
        
        renderCarsTable(filteredCars);
    }
    
    // Clear filters
    function clearFilters() {
        document.getElementById('car-search').value = '';
        document.getElementById('filter-brand').value = '';
        document.getElementById('filter-type').value = '';
        document.getElementById('filter-fuel').value = '';
        filterCars();
    }
    
    // Render cars table
    function renderCarsTable(cars) {
        const container = document.getElementById('cars-container');
        document.getElementById('cars-count').textContent = `${cars.length} car${cars.length !== 1 ? 's' : ''} found`;
        
        if (cars.length === 0) {
            container.innerHTML = '<p class="no-results">No cars found matching your criteria.</p>';
            return;
        }
        
        container.innerHTML = `
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Car</th>
                            <th>Type</th>
                            <th>Fuel</th>
                            <th>Rate</th>
                            <th>Seats/Bags</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cars.map(car => `
                            <tr>
                                <td>#${car.CAR_ID}</td>
                                <td>
                                    <strong>${car.BRAND_NAME} ${car.MODEL_NAME}</strong><br>
                                    <small>${car.COLOUR || 'N/A'}</small>
                                </td>
                                <td>${car.CARTYPE_NAME}</td>
                                <td>${car.FUEL_TYPE || 'N/A'}</td>
                                <td>RM ${parseFloat(car.RATE).toFixed(2)}</td>
                                <td>${car.SEAT || 0} Seats / ${car.SUITCASE || 0} Bags</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="editCar(${car.CAR_ID})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteCar(${car.CAR_ID})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    // Show add car modal
    function showAddCarModal() {
        document.getElementById('modal-title').textContent = 'Add New Car';
        document.getElementById('carForm').reset();
        document.getElementById('car_id').value = '';
        document.getElementById('image-preview').innerHTML = '';
        document.getElementById('current-image').innerHTML = '';
        toggleFuelFields();
        document.getElementById('carModal').style.display = 'block';
    }
    
    // Edit car
    function editCar(carId) {
        fetch(`/api/admin/car/${carId}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const car = data.car;
                    document.getElementById('modal-title').textContent = 'Edit Car';
                    document.getElementById('car_id').value = car.CAR_ID;
                    document.getElementById('car_brand').value = car.BRAND_ID;
                    loadModels();
                    setTimeout(() => {
                        document.getElementById('car_model').value = car.MODEL_ID;
                    }, 500);
                    document.getElementById('car_type').value = car.CARTYPE_ID;
                    document.getElementById('fuel_type').value = car.FUEL_TYPE || '';
                    document.getElementById('car_rate').value = car.RATE;
                    document.getElementById('car_colour').value = car.COLOUR || '';
                    document.getElementById('car_door').value = car.DOOR || '';
                    document.getElementById('car_seat').value = car.SEAT || '';
                    document.getElementById('car_suitcase').value = car.SUITCASE || '';
                    document.getElementById('car_description').value = car.DESCRIPTION || '';
                    document.getElementById('pickup_location').value = car.PICKUP_LOCATION || '';
                    document.getElementById('dropoff_location').value = car.DROPOFF_LOCATION || '';
                    document.getElementById('available_locations').value = car.AVAILABLE_LOCATIONS || '';
                    document.getElementById('allows_different_dropoff').checked = car.ALLOWS_DIFFERENT_DROPOFF == 1;
                    
                    // Fuel type specific fields
                    if (car.FUEL_TYPE === 'Petrol') {
                        document.getElementById('octane_rating').value = car.OCTANE_RATING || '';
                        document.getElementById('petrol_tank').value = car.PETROL_TANK || '';
                    } else if (car.FUEL_TYPE === 'Diesel') {
                        document.getElementById('diesel_emission').value = car.DIESEL_EMISSION || '';
                        document.getElementById('diesel_tank').value = car.DIESEL_TANK || '';
                    } else if (car.FUEL_TYPE === 'Electric') {
                        document.getElementById('battery_range').value = car.BATTERY_RANGE || '';
                        document.getElementById('charging_rate').value = car.CHARGING_RATE_KW || '';
                        if (car.LAST_CHARGING_DATE) {
                            const date = new Date(car.LAST_CHARGING_DATE);
                            document.getElementById('last_charging_date').value = date.toISOString().split('T')[0];
                        }
                    }
                    
                    toggleFuelFields();
                    
                    // Show current image if exists
                    if (car.ATTACHMENTS) {
                        document.getElementById('current-image').innerHTML = `
                            <p>Current Image:</p>
                            <img src="/uploads/${car.ATTACHMENTS}" style="max-width: 200px; height: auto;">
                        `;
                    }
                    
                    document.getElementById('carModal').style.display = 'block';
                }
            });
    }
    
    // Delete car
    function deleteCar(carId) {
        if (!confirm('Are you sure you want to delete this car? This action cannot be undone.')) {
            return;
        }
        
        fetch(`/api/admin/car/${carId}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Car deleted successfully!');
                    loadCars();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    // Save car
    function saveCar(event) {
        event.preventDefault();
        const formData = new FormData(document.getElementById('carForm'));
        const carId = document.getElementById('car_id').value;
        
        fetch(`/api/admin/car${carId ? '/' + carId : ''}`, {
            method: carId ? 'PUT' : 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(carId ? 'Car updated successfully!' : 'Car added successfully!');
                    closeCarModal();
                    loadCars();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(err => {
                alert('Error: ' + err.message);
            });
    }
    
    // Close car modal
    function closeCarModal() {
        document.getElementById('carModal').style.display = 'none';
    }
    
    // Image preview
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').innerHTML = `
                    <p>New Image Preview:</p>
                    <img src="${e.target.result}" style="max-width: 200px; height: auto;">
                `;
            };
            reader.readAsDataURL(file);
        }
    }
    
    // Load bookings
    function loadBookings() {
        fetch('/api/my-bookings')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('bookings-container');
                if (data.success) {
                    const bookings = data.bookings;
                    if (bookings.length === 0) {
                        container.innerHTML = '<p class="no-results">No bookings found.</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="admin-table-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Customer</th>
                                        <th>Car</th>
                                        <th>Pickup Date & Time</th>
                                        <th>Drop-off Date & Time</th>
                                        <th>Pickup Location</th>
                                        <th>Drop-off Location</th>
                                        <th>Price</th>
                                        <th>Payment Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${bookings.map(booking => {
                                        const pickupDate = new Date(booking.PICKUP_DATE);
                                        const dropoffDate = new Date(booking.DROPOFF_DATE);
                                        const isPaid = booking.PAYMENT_STATUS === 'Paid';
                                        const formatDateTime = (d) => d.toLocaleDateString('en-GB') + '<br><small>' + d.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'}) + '</small>';
                                        return `
                                            <tr>
                                                <td>#${booking.BOOKING_ID}</td>
                                                <td>
                                                    ${booking.CUSTOMER_NAME || 'N/A'}<br>
                                                    <small>${booking.CUST_EMAIL || ''}</small><br>
                                                    <small>${booking.CUST_PHONE || ''}</small>
                                                </td>
                                                <td>${booking.BRAND_NAME} ${booking.MODEL_NAME}</td>
                                                <td>${formatDateTime(pickupDate)}</td>
                                                <td>${formatDateTime(dropoffDate)}</td>
                                                <td>${booking.PICKUP_LOCATION || 'N/A'}</td>
                                                <td>${booking.DROPOFF_LOCATION || 'N/A'}</td>
                                                <td>RM ${parseFloat(booking.PRICE).toFixed(2)}</td>
                                                <td>
                                                    <select class="payment-status-select" 
                                                            data-booking-id="${booking.BOOKING_ID}"
                                                            onchange="updatePaymentStatus(${booking.BOOKING_ID}, this.value)"
                                                            style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); font-size: 0.9rem; cursor: pointer;">
                                                        <option value="Pending" ${!isPaid ? 'selected' : ''}>Pending</option>
                                                        <option value="Paid" ${isPaid ? 'selected' : ''}>Paid</option>
                                                    </select>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<p class="error">${data.message}</p>`;
                }
            });
    }
    
    // Load brands and models
    function loadBrandsAndModels() {
        Promise.all([
            fetch('/api/filters').then(res => res.json()),
            fetch('/api/admin/models').then(res => res.json())
        ])
            .then(([brandsData, modelsData]) => {
                if (brandsData.success && modelsData.success) {
                    const container = document.getElementById('brands-container');
                    
                    // Group models by brand
                    const modelsByBrand = {};
                    modelsData.models.forEach(model => {
                        const brandId = model.BRAND_ID;
                        if (!modelsByBrand[brandId]) {
                            modelsByBrand[brandId] = [];
                        }
                        modelsByBrand[brandId].push(model);
                    });
                    
                    container.innerHTML = `
                        <div class="brands-section">
                            <h3>Brands</h3>
                            <div class="admin-table-container">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">ID</th>
                                            <th>Brand Name</th>
                                            <th style="width: 200px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${brandsData.brands.map(brand => `
                                            <tr>
                                                <td>#${brand.BRAND_ID}</td>
                                                <td>${brand.BRAND_NAME}</td>
                                                <td style="white-space: nowrap;">
                                                    <button class="btn btn-sm btn-primary" onclick="editBrand(${brand.BRAND_ID}, '${brand.BRAND_NAME.replace(/'/g, "\\'")}')">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteBrand(${brand.BRAND_ID})">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="models-section" style="margin-top: 2rem;">
                            <h3>Models</h3>
                            <div class="admin-table-container">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">ID</th>
                                            <th>Model Name</th>
                                            <th>Brand</th>
                                            <th style="width: 200px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${modelsData.models.map(model => `
                                            <tr>
                                                <td>#${model.MODEL_ID}</td>
                                                <td>${model.MODEL_NAME}</td>
                                                <td>${model.BRAND_NAME}</td>
                                                <td style="white-space: nowrap;">
                                                    <button class="btn btn-sm btn-primary" onclick="editModel(${model.MODEL_ID}, '${model.MODEL_NAME.replace(/'/g, "\\'")}', ${model.BRAND_ID})">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteModel(${model.MODEL_ID})">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('brands-container').innerHTML = '<p class="error">Failed to load data.</p>';
                }
            })
            .catch(err => {
                document.getElementById('brands-container').innerHTML = '<p class="error">Failed to load brands and models.</p>';
            });
    }
    
    // Brand modals and functions
    function showAddBrandModal() {
        document.getElementById('brand-modal-title').textContent = 'Add New Brand';
        document.getElementById('edit_brand_id').value = '';
        document.getElementById('brand_name').value = '';
        document.getElementById('brandModal').style.display = 'block';
    }
    
    function editBrand(brandId, brandName) {
        document.getElementById('brand-modal-title').textContent = 'Edit Brand';
        document.getElementById('edit_brand_id').value = brandId;
        document.getElementById('brand_name').value = brandName;
        document.getElementById('brandModal').style.display = 'block';
    }
    
    function closeBrandModal() {
        document.getElementById('brandModal').style.display = 'none';
    }
    
    function saveBrand(event) {
        event.preventDefault();
        const brandId = document.getElementById('edit_brand_id').value;
        const brandName = document.getElementById('brand_name').value;
        
        const url = brandId ? `/api/admin/brand/${brandId}` : '/api/admin/brand';
        const method = brandId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({brand_name: brandName})
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(brandId ? 'Brand updated successfully!' : 'Brand added successfully!');
                    closeBrandModal();
                    loadFilters();
                    loadBrandsAndModels();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    function deleteBrand(brandId) {
        if (!confirm('Are you sure you want to delete this brand? This will fail if there are models or cars using this brand.')) {
            return;
        }
        
        fetch(`/api/admin/brand/${brandId}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Brand deleted successfully!');
                    loadFilters();
                    loadBrandsAndModels();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    // Model modals and functions
    function showAddModelModal() {
        document.getElementById('model-modal-title').textContent = 'Add New Model';
        document.getElementById('edit_model_id').value = '';
        document.getElementById('model_name').value = '';
        document.getElementById('model_brand').value = '';
        document.getElementById('modelModal').style.display = 'block';
    }
    
    function editModel(modelId, modelName, brandId) {
        document.getElementById('model-modal-title').textContent = 'Edit Model';
        document.getElementById('edit_model_id').value = modelId;
        document.getElementById('model_name').value = modelName;
        document.getElementById('model_brand').value = brandId;
        document.getElementById('modelModal').style.display = 'block';
    }
    
    function closeModelModal() {
        document.getElementById('modelModal').style.display = 'none';
    }
    
    function saveModel(event) {
        event.preventDefault();
        const modelId = document.getElementById('edit_model_id').value;
        const modelName = document.getElementById('model_name').value;
        const brandId = document.getElementById('model_brand').value;
        
        const url = modelId ? `/api/admin/model/${modelId}` : '/api/admin/model';
        const method = modelId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                model_name: modelName,
                brand_id: brandId
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(modelId ? 'Model updated successfully!' : 'Model added successfully!');
                    closeModelModal();
                    loadFilters();
                    loadBrandsAndModels();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    function deleteModel(modelId) {
        if (!confirm('Are you sure you want to delete this model? This will fail if there are cars using this model.')) {
            return;
        }
        
        fetch(`/api/admin/model/${modelId}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Model deleted successfully!');
                    loadFilters();
                    loadBrandsAndModels();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    // Update payment status
    function updatePaymentStatus(bookingId, status) {
        if (!confirm(`Are you sure you want to change payment status to "${status}"?`)) {
            // Reload to reset dropdown
            loadBookings();
            return;
        }
        
        fetch('/api/admin/booking/payment-status', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                booking_id: bookingId,
                payment_status: status
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Payment status updated successfully!');
                    loadBookings();
                } else {
                    alert('Error: ' + data.message);
                    loadBookings();
                }
            })
            .catch(err => {
                alert('Error: ' + err.message);
                loadBookings();
            });
    }
    
    // ==================== STAFF MANAGEMENT ====================
    
    let isManager = false;
    
    // Password validation function
    function validatePassword(password) {
        if (password.length < 8) {
            return { valid: false, message: 'Password must be at least 8 characters long' };
        }
        if (!/\d/.test(password)) {
            return { valid: false, message: 'Password must contain at least one number' };
        }
        return { valid: true };
    }
    
    // Check if user is manager and show staff tab
    function checkManagerStatus() {
        fetch('/api/admin/check-manager')
            .then(res => res.json())
            .then(data => {
                isManager = data.is_manager;
                if (isManager) {
                    document.getElementById('staff-tab-btn').style.display = 'inline-flex';
                }
            });
    }
    
    // Load staff
    function loadStaff() {
        if (!isManager) return;
        
        const container = document.getElementById('staff-container');
        container.innerHTML = '<div class="loading">Loading staff...</div>';
        
        fetch('/api/admin/staff')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.staff.length === 0) {
                        container.innerHTML = '<p class="no-results">No staff members under your management. Click "Add New Staff" to add one.</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="admin-table-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Department</th>
                                        <th>Username</th>
                                        <th style="width: 200px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.staff.map(s => `
                                        <tr>
                                            <td>#${s.STAFF_ID}</td>
                                            <td>
                                                <strong>${s.STAFF_FNAME} ${s.STAFF_LNAME}</strong>
                                                ${s.SUBORDINATE_COUNT > 0 ? `<br><small style="color: var(--primary-color);"><i class="fas fa-users"></i> ${s.SUBORDINATE_COUNT} staff</small>` : ''}
                                            </td>
                                            <td>${s.STAFF_EMAIL}</td>
                                            <td>${s.STAFF_PHONE || 'N/A'}</td>
                                            <td>${s.STAFF_DEPT || 'N/A'}</td>
                                            <td>${s.STAFF_USERNAME}</td>
                                            <td style="white-space: nowrap;">
                                                <button class="btn btn-sm btn-primary" onclick="editStaff(${s.STAFF_ID})">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteStaff(${s.STAFF_ID})">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<p class="error">${data.message}</p>`;
                }
            })
            .catch(err => {
                container.innerHTML = '<p class="error">Failed to load staff.</p>';
                console.error('Error:', err);
            });
    }
    
    // Show add staff modal
    function showAddStaffModal() {
        document.getElementById('staff-modal-title').textContent = 'Add New Staff';
        document.getElementById('edit_staff_id').value = '';
        document.getElementById('staff_fname').value = '';
        document.getElementById('staff_lname').value = '';
        document.getElementById('staff_email').value = '';
        document.getElementById('staff_phone').value = '';
        document.getElementById('staff_dept').value = '';
        document.getElementById('staff_username').value = '';
        document.getElementById('staff_password').value = '';
        document.getElementById('staff_password').required = true;
        document.getElementById('password-required').style.display = 'inline';
        document.getElementById('password-hint').style.display = 'none';
        document.getElementById('staffModal').style.display = 'block';
    }
    
    // Edit staff
    function editStaff(staffId) {
        fetch(`/api/admin/staff/${staffId}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const s = data.staff;
                    document.getElementById('staff-modal-title').textContent = 'Edit Staff';
                    document.getElementById('edit_staff_id').value = s.STAFF_ID;
                    document.getElementById('staff_fname').value = s.STAFF_FNAME;
                    document.getElementById('staff_lname').value = s.STAFF_LNAME;
                    document.getElementById('staff_email').value = s.STAFF_EMAIL;
                    document.getElementById('staff_phone').value = s.STAFF_PHONE || '';
                    document.getElementById('staff_dept').value = s.STAFF_DEPT || '';
                    document.getElementById('staff_username').value = s.STAFF_USERNAME;
                    document.getElementById('staff_password').value = '';
                    document.getElementById('staff_password').required = false;
                    document.getElementById('password-required').style.display = 'none';
                    document.getElementById('password-hint').style.display = 'block';
                    document.getElementById('staffModal').style.display = 'block';
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    // Close staff modal
    function closeStaffModal() {
        document.getElementById('staffModal').style.display = 'none';
    }
    
    // Save staff
    function saveStaff(event) {
        event.preventDefault();
        const staffId = document.getElementById('edit_staff_id').value;
        const password = document.getElementById('staff_password').value;
        
        // Validate password for new staff or if password is being changed
        if (!staffId || password) {
            if (!staffId && !password) {
                alert('Password is required for new staff');
                return;
            }
            if (password) {
                const passwordCheck = validatePassword(password);
                if (!passwordCheck.valid) {
                    alert(passwordCheck.message);
                    return;
                }
            }
        }
        
        const data = {
            fname: document.getElementById('staff_fname').value,
            lname: document.getElementById('staff_lname').value,
            email: document.getElementById('staff_email').value,
            phone: document.getElementById('staff_phone').value,
            dept: document.getElementById('staff_dept').value,
            username: document.getElementById('staff_username').value
        };
        
        if (password) {
            data.password = password;
        }
        
        const url = staffId ? `/api/admin/staff/${staffId}` : '/api/admin/staff';
        const method = staffId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(staffId ? 'Staff updated successfully!' : 'Staff added successfully!');
                    closeStaffModal();
                    loadStaff();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(err => {
                alert('Error: ' + err.message);
            });
    }
    
    // Delete staff
    function deleteStaff(staffId) {
        if (!confirm('Are you sure you want to delete this staff member? This action cannot be undone.')) {
            return;
        }
        
        fetch(`/api/admin/staff/${staffId}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Staff deleted successfully!');
                    loadStaff();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }
    
    // Initialize on page load
    initAdmin();
    checkManagerStatus();
</script>
{% endblock %}
