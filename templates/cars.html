{% extends "base.html" %}

{% block title %}Car Listing - Carola Car Rental{% endblock %}

{% block content %}
<div class="cars-listing-page">
    <div class="container">
        <div class="listing-header">
            <h1>Car Listing Style 1</h1>
        </div>
        
        <div class="listing-layout">
            <!-- Sidebar Filters -->
            <aside class="filter-sidebar">
                <div class="filter-sidebar-content">
                    <div class="sidebar-header">
                        <h3>Search</h3>
                        <h4>Select Car</h4>
                    </div>
                    
                    <div class="filter-widget">
                        <label>Select Destination</label>
                        <select id="filter-location">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    
                    <div class="filter-widget">
                        <label>Select Type</label>
                        <select id="filter-type">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    
                    <div class="filter-widget">
                        <label>Select Brand</label>
                        <select id="filter-brand">
                            <option value="">All Brands</option>
                        </select>
                    </div>
                    
                    <div class="filter-widget">
                        <label>Select Fuel</label>
                        <select id="filter-fuel">
                            <option value="">All Types</option>
                            <option value="Petrol">Petrol</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Electric">Electric</option>
                        </select>
                    </div>
                    
                    <div class="filter-widget">
                        <label>Filter by Price</label>
                        <div class="price-range-filter">
                            <input type="number" id="min-price" placeholder="Min" min="0">
                            <span>-</span>
                            <input type="number" id="max-price" placeholder="Max" min="0">
                        </div>
                    </div>
                    
                    <div class="filter-widget">
                        <label>Passenger Capacity</label>
                        <div class="capacity-options" id="capacity-options">
                            <!-- Capacity will be populated dynamically -->
                        </div>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-secondary btn-block" onclick="clearFilters()">Clear</button>
                    <button class="btn btn-primary btn-block" onclick="applyFilters()">Apply</button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="listing-content">
                <div id="cars-container" class="cars-grid-listing">
                    <div class="loading">Loading cars...</div>
                </div>
            </main>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let filters = {};
    
    // Get URL parameters for pre-filtering
    const urlParams = new URLSearchParams(window.location.search);
    const urlBrand = urlParams.get('brand');
    const urlType = urlParams.get('type');
    
    // Check if staff tried to book a car
    if (urlParams.get('staff_booking_error')) {
        toastError('Staff members cannot book cars. Please logout and login as a customer to make a booking.');
        // Clean up the URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Load filters
    fetch('/api/filters')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const locationSelect = document.getElementById('filter-location');
                const typeSelect = document.getElementById('filter-type');
                const brandSelect = document.getElementById('filter-brand');
                
                // Populate locations
                if (data.locations) {
                    data.locations.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc.location;
                        option.textContent = loc.location;
                        locationSelect.appendChild(option);
                    });
                }
                
                // Populate car types
                data.types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.CARTYPE_ID;
                    option.textContent = type.CARTYPE_NAME;
                    typeSelect.appendChild(option);
                });
                
                // Populate brands
                data.brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.BRAND_ID;
                    option.textContent = brand.BRAND_NAME;
                    brandSelect.appendChild(option);
                });
                
                // Populate capacity options (passenger seats)
                const capacityContainer = document.getElementById('capacity-options');
                const capacities = [
                    {value: '2', label: '2 Passengers'},
                    {value: '4', label: '4 Passengers'},
                    {value: '5', label: '5 Passengers'},
                    {value: '6', label: '6 Passengers'},
                    {value: '7', label: '7 Passengers'},
                    {value: '8+', label: '8+ Passengers'}
                ];
                capacityContainer.innerHTML = capacities.map(cap => `
                    <label class="capacity-option">
                        <input type="checkbox" value="${cap.value}" onchange="updateCapacityFilter()">
                        <span>${cap.label}</span>
                    </label>
                `).join('');
                
                // Apply URL parameters if present
                if (urlBrand) {
                    brandSelect.value = urlBrand;
                    filters.brand = urlBrand;
                }
                if (urlType) {
                    typeSelect.value = urlType;
                    filters.type = urlType;
                }
                
                // Load cars after filters are set up
                loadCars();
            }
        });
    
    function updateCapacityFilter() {
        const checked = Array.from(document.querySelectorAll('#capacity-options input:checked')).map(cb => cb.value);
        filters.capacity = checked;
        loadCars();
    }
    
    function applyFilters() {
        filters = {
            location: document.getElementById('filter-location').value,
            type: document.getElementById('filter-type').value,
            brand: document.getElementById('filter-brand').value,
            fuel_type: document.getElementById('filter-fuel').value,
            min_price: document.getElementById('min-price').value,
            max_price: document.getElementById('max-price').value
        };
        
        // Add capacity filter if checked
        const checkedCapacity = Array.from(document.querySelectorAll('#capacity-options input:checked')).map(cb => cb.value);
        if (checkedCapacity.length > 0) {
            filters.capacity = checkedCapacity;
        }
        
        loadCars();
    }
    
    function clearFilters() {
        document.getElementById('filter-location').value = '';
        document.getElementById('filter-type').value = '';
        document.getElementById('filter-brand').value = '';
        document.getElementById('filter-fuel').value = '';
        document.getElementById('min-price').value = '';
        document.getElementById('max-price').value = '';
        document.querySelectorAll('#capacity-options input').forEach(cb => cb.checked = false);
        filters = {};
        loadCars();
    }
    
    function loadCars() {
        const container = document.getElementById('cars-container');
        container.innerHTML = '<div class="loading">Loading cars...</div>';
        
        const params = new URLSearchParams();
        Object.keys(filters).forEach(key => {
            if (filters[key] && key !== 'capacity') {
                params.append(key, filters[key]);
            }
        });
        
        fetch(`/api/cars?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    let cars = data.cars;
                    
                    // Filter by passenger capacity (seats)
                    if (filters.capacity && filters.capacity.length > 0) {
                        cars = cars.filter(car => {
                            const seats = car.SEAT || 0;
                            return filters.capacity.some(cap => {
                                if (cap === '8+') return seats >= 8;
                                return seats == parseInt(cap);
                            });
                        });
                    }
                    
                    if (cars.length === 0) {
                        container.innerHTML = '<p class="no-results">No cars found matching your criteria.</p>';
                        return;
                    }
                    
                    container.innerHTML = cars.map(car => `
                        <div class="car-card-listing">
                            <div class="car-image">
                                <img src="${car.ATTACHMENTS ? '/uploads/' + car.ATTACHMENTS : 'https://via.placeholder.com/400x250?text=' + encodeURIComponent(car.BRAND_NAME + ' ' + car.MODEL_NAME)}" 
                                     alt="${car.BRAND_NAME} ${car.MODEL_NAME}" 
                                     onerror="this.src='https://via.placeholder.com/400x250?text=Car+Image'">
                                <div class="car-badge">RM ${parseFloat(car.RATE).toFixed(0)}/ Day</div>
                            </div>
                            <div class="car-info">
                                <h5>${car.BRAND_NAME} ${car.MODEL_NAME}</h5>
                                <p class="car-description">${car.DESCRIPTION || 'Comfortable and reliable vehicle perfect for your journey'}</p>
                                <ul class="car-specs-list">
                                    <li><strong>Doors:</strong> ${car.DOOR || 4} Doors</li>
                                    <li><strong>Suitcase:</strong> ${car.SUITCASE || 0} Bags</li>
                                    <li><strong>Passengers:</strong> ${car.SEAT || 5} Passengers</li>
                                </ul>
                                <a href="/book/${car.CAR_ID}" class="btn btn-primary btn-block">Rent now</a>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `<p class="error">${data.message}</p>`;
                }
            })
            .catch(err => {
                container.innerHTML = '<p class="error">Failed to load cars. Please try again later.</p>';
                console.error('Error:', err);
            });
    }
    
    // Note: Cars are loaded after filters are populated (see above)
</script>
{% endblock %}
