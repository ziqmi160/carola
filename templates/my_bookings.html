{% extends "base.html" %}

{% block title %}My Bookings - Carola Car Rental{% endblock %}

{% block extra_css %}
<style>
    .status-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .booking-status-badge, .payment-status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .booking-status-badge.confirmed { background: #dbeafe; color: #1e40af; }
    .booking-status-badge.in-progress { background: #fef3c7; color: #92400e; }
    .booking-status-badge.completed { background: #d1fae5; color: #065f46; }
    .booking-status-badge.cancelled { background: #fee2e2; color: #991b1b; }
    
    .payment-status-badge.paid { background: #d1fae5; color: #065f46; }
    .payment-status-badge.pending { background: #fef3c7; color: #92400e; }
    
    .booking-card.cancelled {
        opacity: 0.7;
        border-left: 4px solid #ef4444;
    }
    
    .booking-card.in-progress {
        border-left: 4px solid #f59e0b;
    }
    
    .booking-card.completed {
        border-left: 4px solid #10b981;
    }
    
    .cancelled-notice {
        color: #991b1b;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="bookings-page">
    <div class="container">
        <h1 class="page-title">My Bookings</h1>
        
        <div id="bookings-container">
            <div class="loading">Loading bookings...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Cancel booking function
    async function cancelBooking(bookingId) {
        const confirmed = await showConfirm(
            'Cancel Booking',
            'Are you sure you want to cancel this booking? This action cannot be undone.',
            'danger'
        );
        if (!confirmed) return;
        
        fetch(`/api/booking/${bookingId}/cancel`, {
            method: 'POST'
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    toastSuccess('Booking cancelled successfully!');
                    loadBookings(); // Reload the bookings list
                } else {
                    toastError(data.message);
                }
            })
            .catch(err => {
                toastError('Failed to cancel booking. Please try again.');
            });
    }
    
    function loadBookings() {
        fetch('/api/my-bookings')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('bookings-container');
                
                if (data.success) {
                    const bookings = data.bookings;
                    
                    if (bookings.length === 0) {
                        container.innerHTML = '<p class="no-results">You have no bookings yet. <a href="/cars">Browse cars</a> to make a booking.</p>';
                        return;
                    }
                    
                    container.innerHTML = bookings.map(booking => {
                        const pickupDate = new Date(booking.PICKUP_DATE);
                        const dropoffDate = new Date(booking.DROPOFF_DATE);
                        const isPast = dropoffDate < new Date();
                        const isPaid = booking.PAYMENT_STATUS === 'Paid';
                        
                        // Format date and time (UK format DD/MM/YYYY)
                        const formatDateTime = (date) => {
                            return date.toLocaleDateString('en-GB') + ' at ' + date.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'});
                        };
                        
                        const bookingStatus = booking.BOOKING_STATUS || 'Confirmed';
                        const statusIcon = {
                            'Confirmed': 'üìã',
                            'In Progress': 'üöó',
                            'Completed': '‚úÖ',
                            'Cancelled': '‚ùå'
                        }[bookingStatus] || 'üìã';
                        
                        return `
                            <div class="booking-card ${isPast ? 'past' : ''} ${bookingStatus.toLowerCase().replace(' ', '-')}">
                                <div class="booking-header">
                                    <h3>${booking.BRAND_NAME} ${booking.MODEL_NAME}</h3>
                                    <div class="status-badges">
                                        <span class="booking-status-badge ${bookingStatus.toLowerCase().replace(' ', '-')}">${statusIcon} ${bookingStatus}</span>
                                        <span class="payment-status-badge ${isPaid ? 'paid' : 'pending'}">${isPaid ? 'üí∞ Paid' : '‚è≥ Pending'}</span>
                                    </div>
                                </div>
                                <div class="booking-details">
                                    <div class="detail-item">
                                        <i class="fas fa-calendar-alt"></i>
                                        <div>
                                            <strong>Pickup:</strong> ${formatDateTime(pickupDate)}
                                            <br>
                                            <strong>Drop-off:</strong> ${formatDateTime(dropoffDate)}
                                        </div>
                                    </div>
                                    <div class="detail-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <div>
                                            <strong>Pickup:</strong> ${booking.PICKUP_LOCATION || 'N/A'}
                                            <br>
                                            <strong>Drop-off:</strong> ${booking.DROPOFF_LOCATION || 'N/A'}
                                        </div>
                                    </div>
                                    <div class="detail-item">
                                        <i class="fas fa-dollar-sign"></i>
                                        <div>
                                            <strong>Total Price:</strong> RM ${parseFloat(booking.PRICE).toFixed(2)}
                                        </div>
                                    </div>
                                </div>
                                <div class="booking-actions">
                                    ${bookingStatus === 'Cancelled' ? `
                                        <span class="cancelled-notice">This booking has been cancelled</span>
                                    ` : !isPaid ? `
                                        <a href="/payment/${booking.BOOKING_ID}" class="btn btn-primary">
                                            <i class="fas fa-credit-card"></i> Pay Now - RM ${parseFloat(booking.PRICE).toFixed(2)}
                                        </a>
                                        ${pickupDate > new Date() && bookingStatus === 'Confirmed' ? `
                                            <button class="btn btn-danger" onclick="cancelBooking(${booking.BOOKING_ID})">
                                                <i class="fas fa-times"></i> Cancel
                                            </button>
                                        ` : ''}
                                    ` : `
                                        <a href="/booking-confirmation/${booking.BOOKING_ID}" class="btn btn-secondary">
                                            <i class="fas fa-receipt"></i> View Confirmation
                                        </a>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `<p class="error">${data.message}</p>`;
                }
            })
            .catch(err => {
                document.getElementById('bookings-container').innerHTML = '<p class="error">Failed to load bookings. Please try again later.</p>';
            });
    }
    
    // Check for booking_id in URL
    const urlParams = new URLSearchParams(window.location.search);
    const bookingId = urlParams.get('booking_id');
    
    // Load bookings
    loadBookings();
    
    // Scroll to booking if specified
    if (bookingId) {
        setTimeout(() => {
            const bookingCard = document.querySelector(`[data-booking-id="${bookingId}"]`);
            if (bookingCard) {
                bookingCard.scrollIntoView({behavior: 'smooth'});
            }
        }, 500);
    }
</script>
{% endblock %}

