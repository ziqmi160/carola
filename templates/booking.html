{% extends "base.html" %}

{% block title %}Book Car - Carola Car Rental{% endblock %}

{% block content %}
<div class="booking-page">
    <div class="container">
        <h1 class="page-title">Book Your Car</h1>
        
        <div class="booking-container">
            <div class="booking-form-section">
                <h2>Booking Details</h2>
                <form id="bookingForm">
                    <input type="hidden" id="car_id" value="{{ car_id or '' }}">
                    <input type="hidden" id="model_id" value="{{ model_id or '' }}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pickup_date">Pickup Date</label>
                            <input type="date" id="pickup_date" name="pickup_date" required>
                        </div>
                        <div class="form-group">
                            <label for="pickup_time">Pickup Time</label>
                            <select id="pickup_time" name="pickup_time" required>
                                <option value="">Select time...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dropoff_date">Drop-off Date</label>
                            <input type="date" id="dropoff_date" name="dropoff_date" required>
                        </div>
                        <div class="form-group">
                            <label for="dropoff_time">Drop-off Time</label>
                            <select id="dropoff_time" name="dropoff_time" required>
                                <option value="">Select time...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pickup_location">Pickup Location</label>
                        <select id="pickup_location" name="pickup_location" required>
                            <option value="">Select pickup location...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="dropoff_location">Drop-off Location</label>
                        <select id="dropoff_location" name="dropoff_location" required>
                            <option value="">Select drop-off location...</option>
                        </select>
                    </div>
                    
                    <div id="price-summary" class="price-summary" style="display: none;">
                        <h3>Price Summary</h3>
                        <div class="price-details">
                            <p>Daily Rate: <span id="daily-rate">RM 0.00</span></p>
                            <p>Number of Days: <span id="num-days">0</span></p>
                            <p class="total-price">Total: <span id="total-price">RM 0.00</span></p>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">Confirm Booking</button>
                </form>
                <div id="message" class="message"></div>
            </div>
            
            <div class="car-details-section">
                <div id="car-details">
                    <div class="loading">Loading car details...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const carId = document.getElementById('car_id').value;
    const modelId = document.getElementById('model_id').value;
    const isModelBooking = modelId && !carId;  // Model-based booking (choose location)
    
    // Generate time options (15-minute intervals)
    function generateTimeOptions(selectElement, startHour = 0, startMinute = 0) {
        selectElement.innerHTML = '<option value="">Select time...</option>';
        for (let hour = 0; hour < 24; hour++) {
            for (let minute = 0; minute < 60; minute += 15) {
                // Skip times before the start time
                if (hour < startHour || (hour === startHour && minute < startMinute)) {
                    continue;
                }
                const timeValue = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                const displayHour = hour % 12 || 12;
                const ampm = hour < 12 ? 'AM' : 'PM';
                const displayTime = `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;
                const option = document.createElement('option');
                option.value = timeValue;
                option.textContent = displayTime;
                selectElement.appendChild(option);
            }
        }
    }
    
    // Initialize time dropdowns
    const pickupTimeSelect = document.getElementById('pickup_time');
    const dropoffTimeSelect = document.getElementById('dropoff_time');
    generateTimeOptions(pickupTimeSelect);
    generateTimeOptions(dropoffTimeSelect);
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('pickup_date').min = today;
    document.getElementById('dropoff_date').min = today;
    
    // Set default pickup date to today
    document.getElementById('pickup_date').value = today;
    
    // Set default pickup time to next 15-minute interval
    const now = new Date();
    const minutes = now.getMinutes();
    const remainder = minutes % 15;
    let defaultHour = now.getHours();
    let defaultMinute = minutes;
    if (remainder !== 0) {
        defaultMinute = minutes + (15 - remainder);
    } else {
        defaultMinute = minutes + 15;
    }
    if (defaultMinute >= 60) {
        defaultMinute -= 60;
        defaultHour += 1;
    }
    if (defaultHour < 24) {
        pickupTimeSelect.value = `${defaultHour.toString().padStart(2, '0')}:${defaultMinute.toString().padStart(2, '0')}`;
    }
    
    // Update dropoff minimum date when pickup date changes
    document.getElementById('pickup_date').addEventListener('change', function() {
        document.getElementById('dropoff_date').min = this.value;
        if (document.getElementById('dropoff_date').value < this.value) {
            document.getElementById('dropoff_date').value = this.value;
        }
    });
    
    // Store model data for price calculation
    let currentRate = 0;
    let currentModelLocations = [];
    let allowsDifferentDropoff = 0;
    
    // Load car/model details based on booking type
    if (isModelBooking) {
        // MODEL-BASED BOOKING: User can choose pickup location
        loadModelDetails();
    } else {
        // SPECIFIC CAR BOOKING: Pickup location is fixed
        loadCarDetails();
    }
    
    function loadModelDetails() {
        fetch(`/api/model/${modelId}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const model = data.model;
                    const locations = data.locations;
                    currentRate = model.RATE;
                    currentModelLocations = locations;
                    allowsDifferentDropoff = model.ALLOWS_DIFFERENT_DROPOFF;
                    
                    const carDetailsDiv = document.getElementById('car-details');
                    carDetailsDiv.innerHTML = `
                        <div class="car-booking-card">
                            <img src="${model.ATTACHMENTS ? '/uploads/' + model.ATTACHMENTS : 'https://via.placeholder.com/400x300?text=' + encodeURIComponent(model.BRAND_NAME + ' ' + model.MODEL_NAME)}" 
                                 alt="${model.BRAND_NAME} ${model.MODEL_NAME}" 
                                 onerror="this.src='https://via.placeholder.com/400x300?text=Car+Image'">
                            <h2>${model.BRAND_NAME} ${model.MODEL_NAME}</h2>
                            <p class="car-type">${model.CARTYPE_NAME} ‚Ä¢ ${model.FUEL_TYPE || 'N/A'}</p>
                            <p class="car-description">${model.DESCRIPTION || ''}</p>
                            <div class="car-specs">
                                <div class="spec-item"><i class="fas fa-dollar-sign"></i><span>RM ${parseFloat(model.RATE).toFixed(2)}/day</span></div>
                                <div class="spec-item"><i class="fas fa-door-open"></i><span>${model.DOOR} Doors</span></div>
                                <div class="spec-item"><i class="fas fa-users"></i><span>${model.SEAT} Seats</span></div>
                                <div class="spec-item"><i class="fas fa-suitcase"></i><span>${model.SUITCASE} Bags</span></div>
                                <div class="spec-item"><i class="fas fa-palette"></i><span>${model.COLOUR}</span></div>
                            </div>
                            <div class="location-info">
                                <h4>üìç Available Locations</h4>
                                <p><strong>${locations.length} location${locations.length > 1 ? 's' : ''}</strong> with available cars</p>
                                <p class="info-text" style="color: green;"><i class="fas fa-check-circle"></i> Choose your preferred pickup location below</p>
                            </div>
                        </div>
                    `;
                    
                    // Setup location dropdowns for model booking
                    setupModelLocationDropdowns(locations, allowsDifferentDropoff);
                    setupPriceCalculation();
                } else {
                    document.getElementById('car-details').innerHTML = '<p class="error">Model not found.</p>';
                }
            })
            .catch(err => {
                document.getElementById('car-details').innerHTML = '<p class="error">Failed to load model details.</p>';
                console.error(err);
            });
    }
    
    function loadCarDetails() {
        fetch(`/api/car/${carId}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const car = data.car;
                    currentRate = car.RATE;
                    allowsDifferentDropoff = car.ALLOWS_DIFFERENT_DROPOFF;
                    
                    const carDetailsDiv = document.getElementById('car-details');
                    carDetailsDiv.innerHTML = `
                        <div class="car-booking-card">
                            <img src="${car.ATTACHMENTS ? '/uploads/' + car.ATTACHMENTS : 'https://via.placeholder.com/400x300?text=' + encodeURIComponent(car.BRAND_NAME + ' ' + car.MODEL_NAME)}" 
                                 alt="${car.BRAND_NAME} ${car.MODEL_NAME}" 
                                 onerror="this.src='https://via.placeholder.com/400x300?text=Car+Image'">
                            <h2>${car.BRAND_NAME} ${car.MODEL_NAME}</h2>
                            <p class="car-type">${car.CARTYPE_NAME} ‚Ä¢ ${car.FUEL_TYPE || 'N/A'}</p>
                            <p class="car-description">${car.DESCRIPTION || ''}</p>
                            <div class="car-specs">
                                <div class="spec-item"><i class="fas fa-dollar-sign"></i><span>RM ${parseFloat(car.RATE).toFixed(2)}/day</span></div>
                                <div class="spec-item"><i class="fas fa-door-open"></i><span>${car.DOOR} Doors</span></div>
                                <div class="spec-item"><i class="fas fa-users"></i><span>${car.SEAT} Seats</span></div>
                                <div class="spec-item"><i class="fas fa-suitcase"></i><span>${car.SUITCASE} Bags</span></div>
                                <div class="spec-item"><i class="fas fa-palette"></i><span>${car.COLOUR}</span></div>
                            </div>
                            <div class="location-info">
                                <h4>üìç Car Location</h4>
                                <p><strong>${car.HOME_LOCATION || car.PICKUP_LOCATION || 'N/A'}</strong>${car.HOME_CITY ? ', ' + car.HOME_CITY : ''}</p>
                                ${car.ALLOWS_DIFFERENT_DROPOFF == 1 ? '<p class="info-text" style="color: green;"><i class="fas fa-check-circle"></i> Different drop-off allowed</p>' : '<p class="info-text"><i class="fas fa-info-circle"></i> Return to same location</p>'}
                            </div>
                        </div>
                    `;
                    
                    // Setup location dropdowns for specific car booking (fixed pickup)
                    setupCarLocationDropdowns(car);
                    setupPriceCalculation();
                } else {
                    document.getElementById('car-details').innerHTML = '<p class="error">Car not found.</p>';
                }
            })
            .catch(err => {
                document.getElementById('car-details').innerHTML = '<p class="error">Failed to load car details.</p>';
                console.error(err);
            });
    }
    
    function setupModelLocationDropdowns(locations, allowsDifferentDropoff) {
        const pickupSelect = document.getElementById('pickup_location');
        const dropoffSelect = document.getElementById('dropoff_location');
        
        pickupSelect.innerHTML = '';
        dropoffSelect.innerHTML = '';
        
        // PICKUP: User can choose from available locations
        pickupSelect.disabled = false;
        locations.forEach((loc, index) => {
            const option = document.createElement('option');
            option.value = loc.location_id;
            option.textContent = loc.display_name;
            if (index === 0) option.selected = true;
            pickupSelect.appendChild(option);
        });
        
        // DROPOFF: Depends on allows_different_dropoff
        if (allowsDifferentDropoff == 1) {
            dropoffSelect.disabled = false;
            // Add all locations with available cars
            fetch('/api/filters')
                .then(res => res.json())
                .then(filterData => {
                    if (filterData.locations && filterData.locations.length > 0) {
                        filterData.locations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.location_id;
                            option.textContent = loc.display_name;
                            // Pre-select first pickup location
                            if (loc.location_id == pickupSelect.value) {
                                option.selected = true;
                            }
                            dropoffSelect.appendChild(option);
                        });
                    }
                });
        } else {
            // Same as pickup - sync with pickup selection
            dropoffSelect.disabled = true;
            updateDropoffFromPickup();
            pickupSelect.addEventListener('change', updateDropoffFromPickup);
        }
        
        function updateDropoffFromPickup() {
            dropoffSelect.innerHTML = '';
            const selectedPickup = pickupSelect.options[pickupSelect.selectedIndex];
            if (selectedPickup) {
                const option = document.createElement('option');
                option.value = selectedPickup.value;
                option.textContent = selectedPickup.textContent;
                option.selected = true;
                dropoffSelect.appendChild(option);
            }
        }
    }
    
    function setupCarLocationDropdowns(car) {
        const pickupSelect = document.getElementById('pickup_location');
        const dropoffSelect = document.getElementById('dropoff_location');
        
        pickupSelect.innerHTML = '';
        dropoffSelect.innerHTML = '';
        
        const locationDisplay = (car.IS_AIRPORT == 1 ? '‚úàÔ∏è ' : 'üìç ') + 
            (car.HOME_LOCATION || car.PICKUP_LOCATION || 'Unknown') + 
            (car.HOME_CITY ? ' (' + car.HOME_CITY + ')' : '');
        
        // PICKUP: Fixed to car's location
        const pickupOption = document.createElement('option');
        pickupOption.value = car.LOCATION_ID || 0;
        pickupOption.textContent = locationDisplay;
        pickupOption.selected = true;
        pickupSelect.appendChild(pickupOption);
        pickupSelect.disabled = true;
        
        // DROPOFF
        if (car.ALLOWS_DIFFERENT_DROPOFF == 1 && car.LOCATION_ID) {
            dropoffSelect.disabled = false;
            fetch('/api/filters')
                .then(res => res.json())
                .then(filterData => {
                    if (filterData.locations && filterData.locations.length > 0) {
                        filterData.locations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.location_id;
                            option.textContent = loc.display_name;
                            if (loc.location_id == car.LOCATION_ID) option.selected = true;
                            dropoffSelect.appendChild(option);
                        });
                    }
                });
        } else {
            const dropoffOption = document.createElement('option');
            dropoffOption.value = car.LOCATION_ID || 0;
            dropoffOption.textContent = locationDisplay;
            dropoffOption.selected = true;
            dropoffSelect.appendChild(dropoffOption);
            dropoffSelect.disabled = true;
        }
    }
    
    function setupPriceCalculation() {
        document.getElementById('pickup_date').addEventListener('change', calculatePrice);
        document.getElementById('pickup_time').addEventListener('change', calculatePrice);
        document.getElementById('dropoff_date').addEventListener('change', calculatePrice);
        document.getElementById('dropoff_time').addEventListener('change', calculatePrice);
    }
    
    function calculatePrice() {
        const pickupDateVal = document.getElementById('pickup_date').value;
        const pickupTimeVal = document.getElementById('pickup_time').value;
        const dropoffDateVal = document.getElementById('dropoff_date').value;
        const dropoffTimeVal = document.getElementById('dropoff_time').value;
        
        if (pickupDateVal && pickupTimeVal && dropoffDateVal && dropoffTimeVal) {
            const pickupDate = new Date(`${pickupDateVal}T${pickupTimeVal}`);
            const dropoffDate = new Date(`${dropoffDateVal}T${dropoffTimeVal}`);
            
            if (dropoffDate <= pickupDate) {
                toastWarning('Drop-off must be after pickup');
                document.getElementById('dropoff_date').value = '';
                document.getElementById('dropoff_time').value = '';
                document.getElementById('price-summary').style.display = 'none';
                return;
            }
            
            const diffMs = dropoffDate - pickupDate;
            const diffHours = diffMs / (1000 * 60 * 60);
            const days = Math.max(1, Math.ceil(diffHours / 24));
            const rate = parseFloat(currentRate);
            const total = rate * days;
            
            document.getElementById('daily-rate').textContent = `RM ${rate.toFixed(2)}`;
            document.getElementById('num-days').textContent = days;
            document.getElementById('total-price').textContent = `RM ${total.toFixed(2)}`;
            document.getElementById('price-summary').style.display = 'block';
        }
    }
    
    // Handle form submission
    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Combine date and time values
        const pickupDateTime = `${document.getElementById('pickup_date').value}T${document.getElementById('pickup_time').value}`;
        const dropoffDateTime = `${document.getElementById('dropoff_date').value}T${document.getElementById('dropoff_time').value}`;
        
        // Build form data based on booking type
        const formData = {
            pickup_date: pickupDateTime,
            dropoff_date: dropoffDateTime,
            pickup_location_id: parseInt(document.getElementById('pickup_location').value),
            dropoff_location_id: parseInt(document.getElementById('dropoff_location').value)
        };
        
        // Add car_id or model_id depending on booking type
        if (isModelBooking) {
            formData.model_id = parseInt(modelId);
        } else {
            formData.car_id = parseInt(carId);
        }
        
        const messageDiv = document.getElementById('message');
        messageDiv.className = 'message';
        messageDiv.textContent = 'Processing booking...';
        
        try {
            const response = await fetch('/api/bookings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                messageDiv.className = 'message success';
                messageDiv.textContent = 'Booking created! Redirecting to payment...';
                
                // Redirect to payment page
                setTimeout(() => {
                    window.location.href = `/payment/${data.booking_id}`;
                }, 1500);
            } else {
                messageDiv.className = 'message error';
                messageDiv.textContent = data.message;
            }
        } catch (error) {
            messageDiv.className = 'message error';
            messageDiv.textContent = 'An error occurred. Please try again.';
        }
    });
</script>
{% endblock %}

