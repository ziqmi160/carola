{% extends "base.html" %}

{% block title %}Book Car - Carola Car Rental{% endblock %}

{% block content %}
<div class="booking-page">
    <div class="container">
        <h1 class="page-title">Book Your Car</h1>
        
        <div class="booking-container">
            <div class="booking-form-section">
                <h2>Booking Details</h2>
                <form id="bookingForm">
                    <input type="hidden" id="car_id" value="{{ car_id }}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pickup_date">Pickup Date</label>
                            <input type="date" id="pickup_date" name="pickup_date" required>
                        </div>
                        <div class="form-group">
                            <label for="pickup_time">Pickup Time</label>
                            <select id="pickup_time" name="pickup_time" required>
                                <option value="">Select time...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dropoff_date">Drop-off Date</label>
                            <input type="date" id="dropoff_date" name="dropoff_date" required>
                        </div>
                        <div class="form-group">
                            <label for="dropoff_time">Drop-off Time</label>
                            <select id="dropoff_time" name="dropoff_time" required>
                                <option value="">Select time...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pickup_location">Pickup Location</label>
                        <select id="pickup_location" name="pickup_location" required>
                            <option value="">Select pickup location...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="dropoff_location">Drop-off Location</label>
                        <select id="dropoff_location" name="dropoff_location" required>
                            <option value="">Select drop-off location...</option>
                        </select>
                    </div>
                    
                    <div id="price-summary" class="price-summary" style="display: none;">
                        <h3>Price Summary</h3>
                        <div class="price-details">
                            <p>Daily Rate: <span id="daily-rate">RM 0.00</span></p>
                            <p>Number of Days: <span id="num-days">0</span></p>
                            <p class="total-price">Total: <span id="total-price">RM 0.00</span></p>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">Confirm Booking</button>
                </form>
                <div id="message" class="message"></div>
            </div>
            
            <div class="car-details-section">
                <div id="car-details">
                    <div class="loading">Loading car details...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const carId = document.getElementById('car_id').value;
    
    // Generate time options (15-minute intervals)
    function generateTimeOptions(selectElement, startHour = 0, startMinute = 0) {
        selectElement.innerHTML = '<option value="">Select time...</option>';
        for (let hour = 0; hour < 24; hour++) {
            for (let minute = 0; minute < 60; minute += 15) {
                // Skip times before the start time
                if (hour < startHour || (hour === startHour && minute < startMinute)) {
                    continue;
                }
                const timeValue = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                const displayHour = hour % 12 || 12;
                const ampm = hour < 12 ? 'AM' : 'PM';
                const displayTime = `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;
                const option = document.createElement('option');
                option.value = timeValue;
                option.textContent = displayTime;
                selectElement.appendChild(option);
            }
        }
    }
    
    // Initialize time dropdowns
    const pickupTimeSelect = document.getElementById('pickup_time');
    const dropoffTimeSelect = document.getElementById('dropoff_time');
    generateTimeOptions(pickupTimeSelect);
    generateTimeOptions(dropoffTimeSelect);
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('pickup_date').min = today;
    document.getElementById('dropoff_date').min = today;
    
    // Set default pickup date to today
    document.getElementById('pickup_date').value = today;
    
    // Set default pickup time to next 15-minute interval
    const now = new Date();
    const minutes = now.getMinutes();
    const remainder = minutes % 15;
    let defaultHour = now.getHours();
    let defaultMinute = minutes;
    if (remainder !== 0) {
        defaultMinute = minutes + (15 - remainder);
    } else {
        defaultMinute = minutes + 15;
    }
    if (defaultMinute >= 60) {
        defaultMinute -= 60;
        defaultHour += 1;
    }
    if (defaultHour < 24) {
        pickupTimeSelect.value = `${defaultHour.toString().padStart(2, '0')}:${defaultMinute.toString().padStart(2, '0')}`;
    }
    
    // Update dropoff minimum date when pickup date changes
    document.getElementById('pickup_date').addEventListener('change', function() {
        document.getElementById('dropoff_date').min = this.value;
        if (document.getElementById('dropoff_date').value < this.value) {
            document.getElementById('dropoff_date').value = this.value;
        }
    });
    
    // Load car details
    fetch(`/api/car/${carId}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const car = data.car;
                const carDetailsDiv = document.getElementById('car-details');
                
                carDetailsDiv.innerHTML = `
                    <div class="car-booking-card">
                        <img src="${car.ATTACHMENTS ? '/uploads/' + car.ATTACHMENTS : 'https://via.placeholder.com/400x300?text=' + encodeURIComponent(car.BRAND_NAME + ' ' + car.MODEL_NAME)}" 
                             alt="${car.BRAND_NAME} ${car.MODEL_NAME}" 
                             onerror="this.src='https://via.placeholder.com/400x300?text=Car+Image'">
                        <h2>${car.BRAND_NAME} ${car.MODEL_NAME}</h2>
                        <p class="car-type">${car.CARTYPE_NAME} â€¢ ${car.FUEL_TYPE || 'N/A'}</p>
                        <p class="car-description">${car.DESCRIPTION || ''}</p>
                        <div class="car-specs">
                            <div class="spec-item">
                                <i class="fas fa-dollar-sign"></i>
                                <span>RM ${parseFloat(car.RATE).toFixed(2)}/day</span>
                            </div>
                            <div class="spec-item">
                                <i class="fas fa-door-open"></i>
                                <span>${car.DOOR} Doors</span>
                            </div>
                            <div class="spec-item">
                                <i class="fas fa-users"></i>
                                <span>${car.SEAT} Seats</span>
                            </div>
                            <div class="spec-item">
                                <i class="fas fa-suitcase"></i>
                                <span>${car.SUITCASE} Bags</span>
                            </div>
                            <div class="spec-item">
                                <i class="fas fa-palette"></i>
                                <span>${car.COLOUR}</span>
                            </div>
                        </div>
                        ${car.FUEL_TYPE === 'Petrol' ? `
                            <div class="fuel-specs">
                                <h4>Petrol Specifications</h4>
                                <div class="spec-item">
                                    <i class="fas fa-gas-pump"></i>
                                    <span>Octane Rating: ${car.OCTANE_RATING || 'N/A'}</span>
                                </div>
                                <div class="spec-item">
                                    <i class="fas fa-tint"></i>
                                    <span>Fuel Tank Capacity: ${car.PETROL_TANK || 'N/A'}L</span>
                                </div>
                            </div>
                        ` : ''}
                        ${car.FUEL_TYPE === 'Diesel' ? `
                            <div class="fuel-specs">
                                <h4>Diesel Specifications</h4>
                                <div class="spec-item">
                                    <i class="fas fa-leaf"></i>
                                    <span>Emission Standard: ${car.DIESEL_EMISSION || 'N/A'}</span>
                                </div>
                                <div class="spec-item">
                                    <i class="fas fa-tint"></i>
                                    <span>Fuel Tank Capacity: ${car.DIESEL_TANK || 'N/A'}L</span>
                                </div>
                            </div>
                        ` : ''}
                        ${car.FUEL_TYPE === 'Electric' ? `
                            <div class="fuel-specs">
                                <h4>Electric Specifications</h4>
                                <div class="spec-item">
                                    <i class="fas fa-battery-full"></i>
                                    <span>Battery Range: ${car.BATTERY_RANGE || 'N/A'} km</span>
                                </div>
                                <div class="spec-item">
                                    <i class="fas fa-bolt"></i>
                                    <span>Charging Rate: ${car.CHARGING_RATE_KW || 'N/A'} kW</span>
                                </div>
                                <div class="spec-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>Last Charging Date: ${car.LAST_CHARGING_DATE ? new Date(car.LAST_CHARGING_DATE).toLocaleDateString('en-GB') : 'N/A'}</span>
                                </div>
                            </div>
                        ` : ''}
                        <div class="location-info">
                            <h4>Available Locations</h4>
                            <p>${car.AVAILABLE_LOCATIONS || 'N/A'}</p>
                            <h4>Pickup Locations</h4>
                            <p>${car.PICKUP_LOCATION || 'N/A'}</p>
                            ${car.ALLOWS_DIFFERENT_DROPOFF == 1 ? '<p class="info-text"><i class="fas fa-info-circle"></i> Different drop-off location allowed</p>' : '<p class="info-text"><i class="fas fa-info-circle"></i> Same drop-off location required</p>'}
                        </div>
                    </div>
                `;
                
                // Populate pickup location dropdown
                const pickupSelect = document.getElementById('pickup_location');
                if (car.PICKUP_LOCATION) {
                    const pickupLocations = car.PICKUP_LOCATION.split(',').map(loc => loc.trim()).filter(loc => loc);
                    pickupLocations.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc;
                        option.textContent = loc;
                        pickupSelect.appendChild(option);
                    });
                    // Set default to first location
                    if (pickupLocations.length > 0) {
                        pickupSelect.value = pickupLocations[0];
                    }
                }
                
                // Populate dropoff location dropdown
                const dropoffSelect = document.getElementById('dropoff_location');
                if (car.ALLOWS_DIFFERENT_DROPOFF == 1) {
                    // Different dropoff allowed - use dropoff_location field
                    dropoffSelect.disabled = false; // Enable dropdown
                    if (car.DROPOFF_LOCATION) {
                        const dropoffLocations = car.DROPOFF_LOCATION.split(',').map(loc => loc.trim()).filter(loc => loc);
                        dropoffLocations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc;
                            option.textContent = loc;
                            dropoffSelect.appendChild(option);
                        });
                        // Set default to first location
                        if (dropoffLocations.length > 0) {
                            dropoffSelect.value = dropoffLocations[0];
                        }
                    }
                } else {
                    // Same dropoff required - use pickup locations
                    if (car.PICKUP_LOCATION) {
                        const pickupLocations = car.PICKUP_LOCATION.split(',').map(loc => loc.trim()).filter(loc => loc);
                        pickupLocations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc;
                            option.textContent = loc;
                            dropoffSelect.appendChild(option);
                        });
                        // Set default to first location
                        if (pickupLocations.length > 0) {
                            dropoffSelect.value = pickupLocations[0];
                        }
                    }
                    // Disable the dropdown when same dropoff is required
                    dropoffSelect.disabled = true;
                }
                
                // Update dropoff when pickup changes (if same dropoff required)
                if (car.ALLOWS_DIFFERENT_DROPOFF == 0) {
                    pickupSelect.addEventListener('change', function() {
                        dropoffSelect.value = this.value;
                    });
                }
                
                // Update price when dates/times change
                document.getElementById('pickup_date').addEventListener('change', calculatePrice);
                document.getElementById('pickup_time').addEventListener('change', calculatePrice);
                document.getElementById('dropoff_date').addEventListener('change', calculatePrice);
                document.getElementById('dropoff_time').addEventListener('change', calculatePrice);
                
                function calculatePrice() {
                    const pickupDateVal = document.getElementById('pickup_date').value;
                    const pickupTimeVal = document.getElementById('pickup_time').value;
                    const dropoffDateVal = document.getElementById('dropoff_date').value;
                    const dropoffTimeVal = document.getElementById('dropoff_time').value;
                    
                    if (pickupDateVal && pickupTimeVal && dropoffDateVal && dropoffTimeVal) {
                        const pickupDate = new Date(`${pickupDateVal}T${pickupTimeVal}`);
                        const dropoffDate = new Date(`${dropoffDateVal}T${dropoffTimeVal}`);
                        
                        if (dropoffDate <= pickupDate) {
                            alert('Drop-off date and time must be after pickup date and time');
                            document.getElementById('dropoff_date').value = '';
                            document.getElementById('dropoff_time').value = '';
                            document.getElementById('price-summary').style.display = 'none';
                            return;
                        }
                        
                        // Calculate days (minimum 1 day, round up partial days)
                        const diffMs = dropoffDate - pickupDate;
                        const diffHours = diffMs / (1000 * 60 * 60);
                        const days = Math.max(1, Math.ceil(diffHours / 24));
                        const rate = parseFloat(car.RATE);
                        const total = rate * days;
                        
                        document.getElementById('daily-rate').textContent = `RM ${rate.toFixed(2)}`;
                        document.getElementById('num-days').textContent = days;
                        document.getElementById('total-price').textContent = `RM ${total.toFixed(2)}`;
                        document.getElementById('price-summary').style.display = 'block';
                    }
                }
            }
        })
        .catch(err => {
            document.getElementById('car-details').innerHTML = '<p class="error">Failed to load car details.</p>';
        });
    
    // Handle form submission
    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Combine date and time values
        const pickupDateTime = `${document.getElementById('pickup_date').value}T${document.getElementById('pickup_time').value}`;
        const dropoffDateTime = `${document.getElementById('dropoff_date').value}T${document.getElementById('dropoff_time').value}`;
        
        const formData = {
            car_id: parseInt(carId),
            pickup_date: pickupDateTime,
            dropoff_date: dropoffDateTime,
            pickup_location: document.getElementById('pickup_location').value,
            dropoff_location: document.getElementById('dropoff_location').value
        };
        
        const messageDiv = document.getElementById('message');
        messageDiv.className = 'message';
        messageDiv.textContent = 'Processing booking...';
        
        try {
            const response = await fetch('/api/bookings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                messageDiv.className = 'message success';
                messageDiv.textContent = 'Booking created! Redirecting to payment...';
                
                // Redirect to payment page
                setTimeout(() => {
                    window.location.href = `/payment/${data.booking_id}`;
                }, 1500);
            } else {
                messageDiv.className = 'message error';
                messageDiv.textContent = data.message;
            }
        } catch (error) {
            messageDiv.className = 'message error';
            messageDiv.textContent = 'An error occurred. Please try again.';
        }
    });
</script>
{% endblock %}

